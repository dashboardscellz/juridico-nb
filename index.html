<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NB Advocacia ‚Äì Gest√£o Jur√≠dica v6.0</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .bg-navy { background-color: #0f172a; }
    .text-navy { color: #0f172a; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    /* Chips de mat√©ria */
    .chip-civel        { background:#dbeafe; color:#1d4ed8; }
    .chip-previdencia  { background:#dcfce7; color:#15803d; }
    .chip-trabalhista  { background:#f1f5f9; color:#475569; }
    .chip-criminal     { background:#fee2e2; color:#b91c1c; }
    .chip-familia      { background:#fce7f3; color:#be185d; }
    .chip-tributario   { background:#ffedd5; color:#c2410c; }
    .chip-admin        { background:#f3e8ff; color:#7e22ce; }
    .chip-empresarial  { background:#e0e7ff; color:#3730a3; }
    .chip-consumidor   { background:#ccfbf1; color:#0f766e; }
    .chip-default      { background:#f1f5f9; color:#64748b; }
    /* Tags role */
    .tag-master  { background:#7e22ce; color:#fff; }
    .tag-admin   { background:#0f172a; color:#fff; }
    .tag-viewer  { background:#94a3b8; color:#fff; }
    /* Agenda */
    .task-done .task-text { text-decoration: line-through; color: #94a3b8; }
    .priority-alta  { border-left: 3px solid #ef4444; }
    .priority-media { border-left: 3px solid #f59e0b; }
    .priority-baixa { border-left: 3px solid #10b981; }
    /* Focus */
    input:focus, select:focus, textarea:focus {
      border-color: #d97706 !important;
      outline: none;
      box-shadow: 0 0 0 2px rgba(217,119,6,0.15);
    }
    @media print {
      header, .no-print, button { display: none !important; }
      .shadow-sm, .shadow-2xl { box-shadow: none !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;

    // ‚îÄ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const firebaseConfig = {
      apiKey: "AIzaSyAP_VVV_tpGBpDMj77UFM3Z9QnqkdQafNY",
      authDomain: "juridico-nb.firebaseapp.com",
      projectId: "juridico-nb",
      storageBucket: "juridico-nb.firebasestorage.app",
      messagingSenderId: "1039744856084",
      appId: "1:1039744856084:web:75c32201c88da75c413701",
      measurementId: "G-TYQB8QGNG1"
    };
    if (!firebase.apps.length) try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const db   = firebase.firestore();
    const auth = firebase.auth();

    // ‚îÄ‚îÄ‚îÄ COLE√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const COL_PROCESSOS = 'gestao_processos_nb';
    const COL_USUARIOS  = 'credenciais_advocacia';
    const COL_AGENDA    = 'agenda_advocacia';
    const COL_AUDITORIA = 'auditoria_advocacia';

    // ‚îÄ‚îÄ‚îÄ MAT√âRIAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const MATERIAS = [
      { valor: "C√≠vel",          chip: "chip-civel"       },
      { valor: "Previdenci√°rio", chip: "chip-previdencia" },
      { valor: "Trabalhista",    chip: "chip-trabalhista" },
      { valor: "Penal",          chip: "chip-criminal"    },
      { valor: "Criminal",       chip: "chip-criminal"    },
      { valor: "Fam√≠lia",        chip: "chip-familia"     },
      { valor: "Tribut√°rio",     chip: "chip-tributario"  },
      { valor: "Administrativo", chip: "chip-admin"       },
      { valor: "Empresarial",    chip: "chip-empresarial" },
      { valor: "Consumidor",     chip: "chip-consumidor"  },
      { valor: "Outro",          chip: "chip-default"     },
    ];
    const getChip = v => (MATERIAS.find(m => m.valor === v) || { chip: "chip-default" }).chip;

    // ‚îÄ‚îÄ‚îÄ STATUS AGRUPADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const STATUS_GRUPOS = [
      { grupo: "üìã Fase Inicial", itens: [
        "Aguardando protocolo","Protocolado","Aguardando cita√ß√£o / intima√ß√£o","Citado ‚Äì aguardando prazo"
      ]},
      { grupo: "‚öñÔ∏è Fase de Conhecimento", itens: [
        "Em Andamento","Em contesta√ß√£o","Em fase de instru√ß√£o",
        "Audi√™ncia designada","Aguardando laudo pericial","Em per√≠cia","Concluso para senten√ßa"
      ]},
      { grupo: "üîç Criminal / Investigativo", itens: [
        "Em inqu√©rito policial","Em habeas corpus","Em liberdade provis√≥ria",
        "Em pris√£o preventiva","Em sursis processual"
      ]},
      { grupo: "üì£ Recursos", itens: [
        "Em recurso","Em apela√ß√£o","Em agravo de instrumento",
        "Em embargos de declara√ß√£o","Em mandado de seguran√ßa"
      ]},
      { grupo: "‚úÖ Cumprimento / Execu√ß√£o", itens: [
        "Transitado em julgado","Em cumprimento de senten√ßa",
        "Em acordo / concilia√ß√£o","Extinto com resolu√ß√£o do m√©rito","Extinto sem resolu√ß√£o do m√©rito"
      ]},
      { grupo: "üóÇÔ∏è Encerrado", itens: ["Concluso","Arquivado","Suspenso","Cancelado"] },
    ];

    // ‚îÄ‚îÄ‚îÄ ESTADOS & CIDADES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ESTADOS_CIDADES = {
      "PE ‚Äì Pernambuco": ["Recife","Caruaru","Petrolina","Olinda","Paulista","Garanhuns","Goiana",
        "Jaboat√£o dos Guararapes","Cabo de Santo Agostinho","Vit√≥ria de Santo Ant√£o",
        "Arcoverde","Serra Talhada","Santa Cruz do Capibaribe","Carpina","Surubim"],
      "PB ‚Äì Para√≠ba": ["Jo√£o Pessoa","Campina Grande","Patos","Guarabira","Cajazeiras","Sousa","Bayeux","Santa Rita"],
      "AL ‚Äì Alagoas": ["Macei√≥","Arapiraca","Palmeira dos √çndios","Rio Largo","Penedo"],
      "BA ‚Äì Bahia": ["Salvador","Feira de Santana","Vit√≥ria da Conquista","Ilh√©us","Itabuna","Barreiras","Juazeiro","Alagoinhas"],
      "CE ‚Äì Cear√°": ["Fortaleza","Caucaia","Juazeiro do Norte","Maracana√∫","Sobral"],
      "RN ‚Äì Rio Grande do Norte": ["Natal","Mossor√≥","Parnamirim","Caic√≥"],
      "SE ‚Äì Sergipe": ["Aracaju","Lagarto","Itabaiana"],
      "MA ‚Äì Maranh√£o": ["S√£o Lu√≠s","Imperatriz","Timon"],
      "PI ‚Äì Piau√≠": ["Teresina","Parna√≠ba","Floriano"],
      "SP ‚Äì S√£o Paulo": ["S√£o Paulo","Campinas","Santos","Ribeir√£o Preto","Sorocaba","Guarulhos","Santo Andr√©"],
      "RJ ‚Äì Rio de Janeiro": ["Rio de Janeiro","Niter√≥i","Duque de Caxias","Nova Igua√ßu"],
      "MG ‚Äì Minas Gerais": ["Belo Horizonte","Uberl√¢ndia","Contagem","Juiz de Fora","Betim"],
      "DF ‚Äì Distrito Federal": ["Bras√≠lia"],
      "GO ‚Äì Goi√°s": ["Goi√¢nia","Aparecida de Goi√¢nia","An√°polis"],
      "PR ‚Äì Paran√°": ["Curitiba","Londrina","Maring√°","Ponta Grossa"],
      "RS ‚Äì Rio Grande do Sul": ["Porto Alegre","Caxias do Sul","Pelotas","Santa Maria","Canoas"],
    };

    // ‚îÄ‚îÄ‚îÄ TRIBUNAIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const TRIBUNAIS = [
      { grupo: "üèõÔ∏è Estaduais (PJE)", itens: [
        "PJE-PE (TJ-PE)","PJE-PB (TJ-PB)","PJE-AL (TJ-AL)","PJE-BA (TJ-BA)",
        "PJE-CE (TJ-CE)","PJE-RN (TJ-RN)","PJE-SE (TJ-SE)","PJE-MA (TJ-MA)",
        "PJE-PI (TJ-PI)","PJE-GO (TJ-GO)","PJE-PR (TJ-PR)","PJE-RS (TJ-RS)"
      ]},
      { grupo: "üèõÔ∏è Estaduais (Outros)", itens: ["ESAJ-SP (TJ-SP)","ESAJ-RJ (TJ-RJ)","SEEU (Execu√ß√£o Penal)"] },
      { grupo: "‚öñÔ∏è Justi√ßa Federal", itens: ["E-PROC (TRF1)","PJE-JF (TRF2)","PJE-JF (TRF3)","PJE-JF (TRF5)"] },
      { grupo: "üë∑ Justi√ßa do Trabalho", itens: [
        "PJE-TRT2 (SP)","PJE-TRT4 (RS)","PJE-TRT6 (PE)","PJE-TRT7 (CE)",
        "PJE-TRT13 (PB)","PJE-TRT19 (AL)","PJE-TRT20 (SE)"
      ]},
      { grupo: "üî∫ Tribunais Superiores", itens: [
        "STJ ‚Äì Superior Tribunal de Justi√ßa","STF ‚Äì Supremo Tribunal Federal",
        "TST ‚Äì Tribunal Superior do Trabalho","TSE ‚Äì Tribunal Superior Eleitoral"
      ]},
      { grupo: "üè¢ Outros", itens: [
        "CEJUSC (Concilia√ß√£o)","PROCON","Delegacia Civil",
        "Minist√©rio P√∫blico Estadual","Minist√©rio P√∫blico Federal"
      ]},
    ];

    // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const formatCPF   = v => v.replace(/\D/g,'').slice(0,11)
      .replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/,'$1.$2.$3-$4').replace(/-$/,'');
    const formatPhone = v => {
      const d = v.replace(/\D/g,'').slice(0,11);
      return d.length <= 10
        ? d.replace(/(\d{2})(\d{4})(\d{0,4})/,'($1) $2-$3')
        : d.replace(/(\d{2})(\d{5})(\d{0,4})/,'($1) $2-$3');
    };
    const openWhatsApp = phone => {
      const c = phone.replace(/\D/g,'');
      if (c) window.open(`https://wa.me/55${c}`,'_blank');
      else alert('N√∫mero inv√°lido.');
    };

    // ‚îÄ‚îÄ‚îÄ √çCONES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Icons = {
      Scale:     () => <svg className="w-8 h-8" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>,
      Plus:      () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>,
      Search:    () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
      X:         () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>,
      Trash:     () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
      Edit:      () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>,
      Calculator:() => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>,
      Excel:     () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>,
      Check:     () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>,
      Users:     () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
      WhatsApp:  () => <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.867-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.199-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>,
      LogOut:    () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
      History:   () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
      Eye:       () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>,
      EyeOff:    () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>,
      Key:       () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>,
      ChevLeft:  () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7"/></svg>,
      ChevRight: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7"/></svg>,
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CALCULADORA DE PRAZO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CalculatorModal = ({ onClose }) => {
      const [dataInicial, setDataInicial] = useState("");
      const [dias, setDias] = useState("");
      const [tipo, setTipo] = useState("uteis");
      const [resultado, setResultado] = useState(null);

      const calcular = () => {
        if (!dataInicial || !dias) return;
        const dt = new Date(dataInicial);
        dt.setMinutes(dt.getMinutes() + dt.getTimezoneOffset());
        let count = 0;
        const target = parseInt(dias);
        while (count < target) {
          dt.setDate(dt.getDate() + 1);
          if (tipo === 'uteis') { const d = dt.getDay(); if (d !== 0 && d !== 6) count++; }
          else count++;
        }
        setResultado(dt.toLocaleDateString('pt-BR'));
      };

      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 fade-in">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div className="bg-navy p-4 flex justify-between items-center text-white">
              <h3 className="font-bold flex gap-2 items-center text-lg"><Icons.Calculator/> Calculadora de Prazo</h3>
              <button onClick={onClose}><Icons.X/></button>
            </div>
            <div className="p-6 space-y-4">
              <p className="text-center text-sm text-slate-500 font-semibold uppercase tracking-wide">Insira os dados para calcular o prazo</p>
              <div className="space-y-2">
                <select className="w-full p-2 border rounded bg-white text-slate-600 text-sm"><option>Pernambuco (PE)</option><option>Para√≠ba (PB)</option><option>S√£o Paulo (SP)</option></select>
                <select className="w-full p-2 border rounded bg-white text-slate-600 text-sm"><option>Recife</option><option>Goiana</option><option>Jo√£o Pessoa</option></select>
                <select className="w-full p-2 border rounded bg-white text-slate-600 text-sm"><option>C√≠vel</option><option>Penal</option><option>Trabalhista</option></select>
                <select className="w-full p-2 border rounded bg-white text-slate-600 text-sm"><option>TJPE</option><option>TRF5</option><option>TRT6</option></select>
              </div>
              <div className="pt-2 border-t">
                <label className="text-xs font-bold text-slate-700 uppercase block mb-1">Data da Publica√ß√£o</label>
                <input type="date" className="w-full p-3 border rounded text-lg text-center font-bold" value={dataInicial} onChange={e=>setDataInicial(e.target.value)}/>
              </div>
              <div>
                <label className="text-xs font-bold text-slate-700 uppercase block mb-1">Prazo em Dias</label>
                <input type="number" className="w-full p-3 border rounded text-lg text-center font-bold" placeholder="0" value={dias} onChange={e=>setDias(e.target.value)}/>
              </div>
              <div className="flex justify-center gap-8 py-1">
                <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="tp" checked={tipo==='uteis'} onChange={()=>setTipo('uteis')}/><span className="font-bold text-slate-700">√öteis</span></label>
                <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="tp" checked={tipo==='corridos'} onChange={()=>setTipo('corridos')}/><span className="font-bold text-slate-700">Corridos</span></label>
              </div>
              <button onClick={calcular} className="w-full bg-orange-600 text-white font-bold py-3 rounded hover:bg-orange-700 shadow-lg transition">CALCULAR PRAZO FINAL</button>
              {resultado && (
                <div className="bg-green-50 p-4 rounded-lg text-center border border-green-200">
                  <p className="text-xs text-green-700 font-bold uppercase">Data Final do Prazo</p>
                  <p className="text-3xl font-bold text-green-800">{resultado}</p>
                  <p className="text-[10px] text-slate-400 mt-1">*Verifique feriados locais.</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LOGIN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const LoginScreen = ({ onLogin }) => {
      const [user, setUser]       = useState("");
      const [pass, setPass]       = useState("");
      const [error, setError]     = useState("");
      const [loading, setLoading] = useState(false);
      const [showPass, setShowPass] = useState(false);

      const handle = async e => {
        e.preventDefault();
        setLoading(true); setError("");
        if (user === "NB ADVOCACIA" && pass === "NB07242530") { onLogin(user, "master"); return; }
        try {
          const doc = await db.collection(COL_USUARIOS).doc(user).get();
          if (doc.exists && doc.data().senha === pass) onLogin(user, doc.data().role || 'viewer');
          else setError("Usu√°rio ou senha incorretos.");
        } catch(e) { setError("Erro de conex√£o. Verifique a internet."); }
        setLoading(false);
      };

      return (
        <div className="min-h-screen bg-navy flex items-center justify-center p-4">
          <div className="w-full max-w-md bg-white rounded-xl shadow-2xl p-8 fade-in">
            <div className="text-center mb-6">
              <div className="text-yellow-600 flex justify-center mb-2"><Icons.Scale/></div>
              <h2 className="text-2xl font-bold text-slate-800">NB ADVOCACIA</h2>
              <p className="text-xs text-slate-500 uppercase tracking-widest">Acesso Restrito</p>
            </div>
            <form onSubmit={handle} className="space-y-4">
              <input className="w-full p-3 border rounded" placeholder="Usu√°rio" value={user} onChange={e=>setUser(e.target.value)}/>
              <div className="relative">
                <input type={showPass?"text":"password"} className="w-full p-3 border rounded pr-10" placeholder="Senha" value={pass} onChange={e=>setPass(e.target.value)}/>
                <button type="button" onClick={()=>setShowPass(!showPass)} className="absolute right-3 top-3 text-slate-400 hover:text-slate-600">
                  {showPass ? <Icons.EyeOff/> : <Icons.Eye/>}
                </button>
              </div>
              {error && <p className="text-red-500 text-sm text-center">{error}</p>}
              <button disabled={loading} className="w-full bg-navy text-white py-3 rounded font-bold hover:bg-slate-800 transition">
                {loading ? "VERIFICANDO..." : "ENTRAR"}
              </button>
            </form>
          </div>
        </div>
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AGENDA DI√ÅRIA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const AgendaDiaria = ({ socio, registrarLog }) => {
      const hoje = new Date().toISOString().split('T')[0];
      const [dataSel, setDataSel]   = useState(hoje);
      const [tarefas, setTarefas]   = useState([]);
      const [notas, setNotas]       = useState("");
      const [novaTarefa, setNovaTarefa] = useState({ texto: "", hora: "", prioridade: "media" });
      const [loading, setLoading]   = useState(false);
      const [salvando, setSalvando] = useState(false);
      const notasTimer = useRef(null);
      const docId = `agenda_${dataSel.replace(/-/g,'')}`;

      const carregar = async data => {
        setLoading(true);
        try {
          const doc = await db.collection(COL_AGENDA).doc(`agenda_${data.replace(/-/g,'')}`).get();
          if (doc.exists) { const d = doc.data(); setTarefas(d.tarefas||[]); setNotas(d.notas||""); }
          else { setTarefas([]); setNotas(""); }
        } catch(e) {}
        setLoading(false);
      };
      useEffect(() => { carregar(dataSel); }, [dataSel]);

      const salvarAgenda = async (novasTarefas, novaNota) => {
        setSalvando(true);
        try {
          await db.collection(COL_AGENDA).doc(docId).set({
            data: dataSel,
            tarefas: novasTarefas !== undefined ? novasTarefas : tarefas,
            notas:   novaNota    !== undefined ? novaNota    : notas,
            atualizadoEm: new Date().toISOString(), usuario: socio,
          });
        } catch(e) {}
        setTimeout(()=>setSalvando(false), 600);
      };

      const adicionarTarefa = async () => {
        if (!novaTarefa.texto.trim()) return;
        const t = { id: Date.now().toString(), texto: novaTarefa.texto, hora: novaTarefa.hora, prioridade: novaTarefa.prioridade, feito: false, criadoEm: new Date().toISOString() };
        const nova = [...tarefas, t];
        setTarefas(nova); setNovaTarefa({ texto:"", hora:"", prioridade:"media" });
        await salvarAgenda(nova); registrarLog("AGENDA", `Tarefa: ${t.texto}`);
      };

      const toggleTarefa = async id => {
        const nova = tarefas.map(t => t.id===id ? {...t, feito: !t.feito} : t);
        setTarefas(nova); await salvarAgenda(nova);
      };

      const excluirTarefa = async id => {
        const nova = tarefas.filter(t=>t.id!==id);
        setTarefas(nova); await salvarAgenda(nova);
      };

      const transferirAmanha = async () => {
        const pendentes = tarefas.filter(t=>!t.feito);
        if (!pendentes.length) { alert("Nenhuma tarefa pendente."); return; }
        const amanha = new Date(dataSel); amanha.setDate(amanha.getDate()+1);
        const amanhaStr = amanha.toISOString().split('T')[0];
        const docAmanha = `agenda_${amanhaStr.replace(/-/g,'')}`;
        try {
          const ex = await db.collection(COL_AGENDA).doc(docAmanha).get();
          const existentes = ex.exists ? (ex.data().tarefas||[]) : [];
          const transferidas = pendentes.map(t=>({...t, id: Date.now().toString()+Math.random(), transferidaDe:dataSel, feito:false}));
          await db.collection(COL_AGENDA).doc(docAmanha).set({
            data: amanhaStr, tarefas:[...existentes,...transferidas],
            notas: ex.exists?(ex.data().notas||""):"",
            atualizadoEm: new Date().toISOString(), usuario: socio,
          });
          registrarLog("AGENDA", `Transferiu ${pendentes.length} tarefa(s) para ${amanhaStr}`);
          alert(`‚úÖ ${pendentes.length} tarefa(s) transferida(s) para amanh√£!`);
        } catch(e) { alert("Erro ao transferir."); }
      };

      const onNotasChange = val => {
        setNotas(val); clearTimeout(notasTimer.current);
        notasTimer.current = setTimeout(()=>salvarAgenda(undefined,val),1200);
      };

      const navegarDia = delta => {
        const d = new Date(dataSel); d.setDate(d.getDate()+delta);
        setDataSel(d.toISOString().split('T')[0]);
      };

      const feitas   = tarefas.filter(t=>t.feito).length;
      const total    = tarefas.length;
      const progresso = total>0 ? (feitas/total)*100 : 0;
      const isHoje   = dataSel === hoje;

      const formatarData = d => {
        const dias   = ['Domingo','Segunda-feira','Ter√ßa-feira','Quarta-feira','Quinta-feira','Sexta-feira','S√°bado'];
        const meses  = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const dt     = new Date(d+'T12:00:00');
        return `${dias[dt.getDay()]}, ${dt.getDate()} de ${meses[dt.getMonth()]} de ${dt.getFullYear()}`;
      };

      const prioCfg = {
        alta:  { cls:'priority-alta',  bg:'bg-red-50',     cor:'text-red-600',    label:'üî¥ Alta'  },
        media: { cls:'priority-media', bg:'bg-amber-50',   cor:'text-amber-600',  label:'üü° M√©dia' },
        baixa: { cls:'priority-baixa', bg:'bg-emerald-50', cor:'text-emerald-600',label:'üü¢ Baixa' },
      };

      return (
        <div className="space-y-5 fade-in">
          {/* Cabe√ßalho da Agenda */}
          <div className="bg-white rounded-xl shadow-sm p-5">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
              <div>
                <h2 className="text-xl font-bold text-slate-800 font-serif">üìì Agenda Di√°ria</h2>
                <p className="text-xs text-slate-500">Seu di√°rio de metas e tarefas</p>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={()=>navegarDia(-1)} className="p-2 rounded-lg border hover:bg-slate-50 text-slate-500"><Icons.ChevLeft/></button>
                <div className="text-center">
                  <input type="date" value={dataSel} onChange={e=>setDataSel(e.target.value)} className="border rounded-lg px-3 py-2 text-sm font-medium text-slate-700"/>
                  {!isHoje && <button onClick={()=>setDataSel(hoje)} className="block text-xs text-yellow-600 underline mx-auto mt-1">Ir para hoje</button>}
                </div>
                <button onClick={()=>navegarDia(1)} className="p-2 rounded-lg border hover:bg-slate-50 text-slate-500"><Icons.ChevRight/></button>
              </div>
            </div>

            <div className="bg-slate-50 p-3 rounded-lg mb-4">
              <p className="text-sm font-semibold text-slate-600">{formatarData(dataSel)}</p>
              {total > 0 && (
                <div className="mt-2">
                  <div className="flex justify-between text-xs text-slate-500 mb-1"><span>{feitas}/{total} tarefas</span><span>{Math.round(progresso)}%</span></div>
                  <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div className="h-2 bg-yellow-500 rounded-full transition-all duration-700" style={{width:`${progresso}%`}}/>
                  </div>
                  {progresso===100 && <p className="text-[10px] text-emerald-600 font-bold mt-1 text-center">üèÜ Meta do dia atingida!</p>}
                </div>
              )}
              {salvando && <p className="text-[10px] text-slate-400 mt-1">Salvando...</p>}
            </div>

            {/* Nova tarefa */}
            <div className="bg-slate-50 rounded-xl p-3 border border-slate-200 mb-4">
              <p className="text-[10px] font-bold text-slate-500 uppercase mb-2">Nova Tarefa</p>
              <div className="flex gap-2 flex-wrap">
                <input className="flex-1 min-w-[160px] p-2 border rounded text-sm bg-white"
                  placeholder="Descri√ß√£o da tarefa..." value={novaTarefa.texto}
                  onChange={e=>setNovaTarefa({...novaTarefa,texto:e.target.value})}
                  onKeyDown={e=>e.key==='Enter'&&adicionarTarefa()}/>
                <input type="time" className="p-2 border rounded text-sm bg-white w-28" value={novaTarefa.hora}
                  onChange={e=>setNovaTarefa({...novaTarefa,hora:e.target.value})}/>
                <select className="p-2 border rounded text-sm bg-white" value={novaTarefa.prioridade}
                  onChange={e=>setNovaTarefa({...novaTarefa,prioridade:e.target.value})}>
                  <option value="alta">üî¥ Alta</option>
                  <option value="media">üü° M√©dia</option>
                  <option value="baixa">üü¢ Baixa</option>
                </select>
                <button onClick={adicionarTarefa}
                  className="bg-navy text-white px-4 py-2 rounded text-sm font-bold hover:bg-slate-800 flex items-center gap-1 transition">
                  <Icons.Plus/> Adicionar
                </button>
              </div>
            </div>

            {/* Lista de tarefas */}
            {loading ? (
              <p className="text-slate-400 text-sm text-center py-4">Carregando...</p>
            ) : (
              <div className="space-y-2">
                {tarefas.length === 0 && <p className="text-slate-400 text-sm text-center py-6">Nenhuma tarefa para este dia.</p>}
                {tarefas.map(t => {
                  const cfg = prioCfg[t.prioridade] || prioCfg.media;
                  return (
                    <div key={t.id} className={`flex items-start gap-3 p-3 rounded-lg border bg-white ${cfg.cls} ${t.feito?'task-done':''}`}>
                      <input type="checkbox" className="mt-0.5 w-4 h-4 cursor-pointer accent-yellow-600" checked={t.feito} onChange={()=>toggleTarefa(t.id)}/>
                      <div className="flex-1 min-w-0">
                        <p className={`task-text text-sm font-medium text-slate-700`}>{t.texto}</p>
                        <div className="flex items-center gap-2 mt-1">
                          {t.hora && <span className="text-[10px] text-slate-400">üïê {t.hora}</span>}
                          <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${cfg.bg} ${cfg.cor}`}>{cfg.label}</span>
                          {t.transferidaDe && <span className="text-[10px] text-slate-400">‚Ü© Transferida</span>}
                        </div>
                      </div>
                      <button onClick={()=>excluirTarefa(t.id)} className="text-slate-300 hover:text-red-500 shrink-0"><Icons.Trash/></button>
                    </div>
                  );
                })}
              </div>
            )}

            {tarefas.filter(t=>!t.feito).length > 0 && (
              <button onClick={transferirAmanha}
                className="mt-4 w-full py-2 text-xs font-bold text-slate-500 border border-dashed border-slate-300 rounded-lg hover:bg-slate-50 flex items-center justify-center gap-2">
                ‚Ü© Transferir pendentes para amanh√£
              </button>
            )}
          </div>

          {/* Notas do dia */}
          <div className="bg-white rounded-xl shadow-sm p-5">
            <h3 className="font-bold text-slate-700 mb-3">üìù Notas do Dia</h3>
            <textarea
              className="w-full border rounded-lg p-3 text-sm resize-none text-slate-700 leading-relaxed"
              rows={9}
              placeholder={"Suas anota√ß√µes do dia...\n\n‚Ä¢ Pontos importantes\n‚Ä¢ Observa√ß√µes de clientes\n‚Ä¢ Lembretes\n‚Ä¢ Ideias"}
              value={notas}
              onChange={e=>onNotasChange(e.target.value)}
            />
            <p className="text-[10px] text-slate-300 mt-1 text-right">Salvo automaticamente</p>
          </div>
        </div>
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PROCESSOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ProcessosView = ({ socio, role, privacidade, registrarLog, novoTrigger }) => {
      const FORM_VAZIO = {
        cliente:"", cpf:"", telefone:"", parteContraria:"", descricao:"",
        ramo:"C√≠vel", statusProcessual:"Em Andamento",
        semProcesso:false, numeroProcesso:"",
        estado:"PE ‚Äì Pernambuco", cidade:"Recife",
        tribunal:"PJE-PE (TJ-PE)", vara:"",
        advogado:"Evison Nascimento", prazo:"",
        // Previdenci√°rio
        patologia:"", govLogin:"", govSenha:"", dataPericia:"", dataSocial:"",
        // Documentos
        procuracaoEntregue:false, linkProcuracao:"",
        contratoEntregue:false,  linkContrato:"",
        // Honor√°rios
        tipoPagamento:"Valor Cheio", statusPagamento:"Pendente",
        qtdParcelas:"", valorParcela:"", valorContrato:"",
        percentualContrato:"", valorEntrada:"",
        criadoEm:"",
      };

      const [processos, setProcessos]   = useState([]);
      const [modal, setModal]           = useState(false);
      const [editingId, setEditingId]   = useState(null);
      const [formData, setFormData]     = useState(FORM_VAZIO);
      const [busca, setBusca]           = useState("");
      const [filtroRamo, setFiltroRamo] = useState("");
      const [calcModal, setCalcModal]   = useState(false);
      const [cidadesDaUF, setCidadesDaUF] = useState(ESTADOS_CIDADES["PE ‚Äì Pernambuco"]);

      // Ouve trigger do bot√£o NOVO PROCESSO no header
      useEffect(() => {
        if (novoTrigger > 0) { setFormData(FORM_VAZIO); setEditingId(null); setModal(true); }
      }, [novoTrigger]);

      useEffect(() => {
        const unsub = db.collection(COL_PROCESSOS).orderBy('criadoEm','desc')
          .onSnapshot(snap => setProcessos(snap.docs.map(d=>({id:d.id,...d.data()}))), ()=>{});
        return ()=>unsub();
      }, []);

      useEffect(()=>{
        const cidades = ESTADOS_CIDADES[formData.estado] || [];
        setCidadesDaUF(cidades);
        if (cidades.length && !cidades.includes(formData.cidade)) setFormData(f=>({...f, cidade:cidades[0]}));
      }, [formData.estado]);

      const salvar = async () => {
        if (!formData.cliente.trim()) { alert("Informe o nome do cliente."); return; }
        if (role === 'viewer') { alert("Sem permiss√£o."); return; }
        try {
          const dados = {...formData, atualizadoEm: new Date().toISOString()};
          if (editingId) {
            await db.collection(COL_PROCESSOS).doc(editingId).update(dados);
            registrarLog("PROCESSO EDITADO", formData.cliente);
          } else {
            dados.criadoEm = new Date().toISOString();
            await db.collection(COL_PROCESSOS).add(dados);
            registrarLog("PROCESSO CADASTRADO", `${formData.cliente} ‚Äì ${formData.ramo}`);
          }
          setModal(false); setFormData(FORM_VAZIO); setEditingId(null);
        } catch(e) { alert("Erro ao salvar: "+e.message); }
      };

      const apagar = async (id, nome) => {
        if (role==='viewer') { alert("Sem permiss√£o."); return; }
        if (!confirm(`Remover processo de ${nome}?`)) return;
        await db.collection(COL_PROCESSOS).doc(id).delete();
        registrarLog("PROCESSO EXCLU√çDO", nome);
      };

      const exportar = () => {
        if (!window.XLSX) { alert("XLSX n√£o carregado."); return; }
        const dados = processos.map(p => ({
          "Cliente":p.cliente,"CPF":p.cpf,"Telefone":p.telefone,
          "Ramo":p.ramo,"N¬∫ Processo":p.numeroProcesso,
          "Status":p.statusProcessual,"Advogado":p.advogado,
          "Estado":p.estado,"Cidade":p.cidade,"Tribunal":p.tribunal,
          "Prazo":p.prazo,"Tipo Pgto":p.tipoPagamento,
          "Valor":p.valorContrato,"Pag.":p.statusPagamento,
        }));
        const ws = XLSX.utils.json_to_sheet(dados);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Processos");
        XLSX.writeFile(wb, "Processos_NB.xlsx");
      };

      const processosFiltrados = useMemo(() => processos.filter(p => {
        const lb = busca.toLowerCase();
        const mB = !busca || p.cliente?.toLowerCase().includes(lb) || p.cpf?.includes(busca) || p.numeroProcesso?.toLowerCase().includes(lb);
        const mR = !filtroRamo || p.ramo===filtroRamo;
        return mB && mR;
      }), [processos, busca, filtroRamo]);

      const renderFin = p => {
        if (privacidade) return "‚Ä¢‚Ä¢‚Ä¢";
        if (p.tipoPagamento==='Parcelado') return `${p.qtdParcelas}x ${p.valorParcela}`;
        if (p.tipoPagamento==='√äxito' || p.tipoPagamento==='exito') return `√äxito ${p.percentualContrato?p.percentualContrato+'%':''}`;
        if (p.tipoPagamento==='Misto' || p.tipoPagamento==='misto') return `R$ ${p.valorEntrada||0} + ${p.percentualContrato||0}%`;
        return p.valorContrato ? `R$ ${p.valorContrato}` : '-';
      };

      const setF = patch => setFormData(f=>({...f,...patch}));

      return (
        <div className="fade-in">
          {calcModal && <CalculatorModal onClose={()=>setCalcModal(false)}/>}

          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            {/* Barra de filtros */}
            <div className="p-4 border-b bg-slate-50 flex flex-col md:flex-row gap-3 justify-between items-center">
              <div className="flex items-center gap-2 flex-1 w-full">
                <div className="relative flex-1">
                  <span className="absolute left-3 top-2.5 text-slate-400"><Icons.Search/></span>
                  <input type="text" placeholder="Buscar por cliente, CPF, processo..." value={busca}
                    className="pl-9 pr-4 py-2 border rounded-lg text-sm w-full"
                    onChange={e=>setBusca(e.target.value)}/>
                </div>
                <select className="border rounded-lg text-sm p-2 bg-white text-slate-600" value={filtroRamo} onChange={e=>setFiltroRamo(e.target.value)}>
                  <option value="">Todos os Ramos</option>
                  {MATERIAS.map(m=><option key={m.valor} value={m.valor}>{m.valor}</option>)}
                </select>
              </div>
              <div className="flex gap-2">
                <button onClick={exportar} className="flex items-center gap-1 text-xs font-bold bg-green-50 text-green-700 border border-green-200 px-3 py-2 rounded hover:bg-green-100"><Icons.Excel/> Excel</button>
                <button onClick={()=>setCalcModal(true)} className="px-3 py-2 rounded text-sm font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 flex items-center gap-2 border border-slate-200">
                  <Icons.Calculator/><span className="hidden md:inline">Calc. Prazo</span>
                </button>
              </div>
            </div>

            {/* Tabela */}
            <div className="overflow-x-auto">
              <table className="w-full text-sm text-left whitespace-nowrap">
                <thead className="bg-slate-100 text-slate-500 font-bold border-b">
                  <tr>
                    <th className="px-4 py-3">Status</th>
                    <th className="px-4 py-3">Cliente</th>
                    <th className="px-4 py-3">Processo / Ramo</th>
                    <th className="px-4 py-3">Resp.</th>
                    <th className="px-4 py-3">Prazo</th>
                    <th className="px-4 py-3">Financeiro</th>
                    <th className="px-4 py-3 text-center">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {processosFiltrados.length===0 && (
                    <tr><td colSpan="7" className="text-center py-12 text-slate-400">Nenhum processo encontrado.</td></tr>
                  )}
                  {processosFiltrados.map(p => {
                    const st = p.statusProcessual || "Em Andamento";
                    const stColor = (st==='Concluso'||st.includes('julgado'))
                      ? 'bg-green-100 text-green-700'
                      : (st==='Arquivado'||st==='Cancelado'||st==='Suspenso')
                      ? 'bg-slate-100 text-slate-500'
                      : 'bg-blue-50 text-blue-700';
                    const chip = getChip(p.ramo);
                    const hoje = new Date(); hoje.setHours(0,0,0,0);
                    const prazoVencido = p.prazo && new Date(p.prazo) < hoje;
                    return (
                      <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                        <td className="px-4 py-3">
                          <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${stColor}`}>{st}</span>
                        </td>
                        <td className="px-4 py-3">
                          <div className="font-bold text-slate-700 flex items-center gap-1.5">
                            {p.cliente}
                            {p.telefone && <button onClick={()=>openWhatsApp(p.telefone)} className="text-green-500 hover:text-green-600 shrink-0" title="WhatsApp"><Icons.WhatsApp/></button>}
                          </div>
                          {p.cpf && <div className="text-xs text-slate-400">{p.cpf}</div>}
                          {p.parteContraria && <div className="text-[10px] text-slate-300">vs. {p.parteContraria}</div>}
                        </td>
                        <td className="px-4 py-3">
                          <div className="font-mono text-xs text-slate-700">{p.semProcesso?'PR√â-PROCESSUAL':(p.numeroProcesso||'S/N')}</div>
                          <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${chip}`}>{p.ramo}</span>
                          {(p.cidade||p.tribunal) && (
                            <div className="text-[10px] text-slate-400 mt-0.5">{[p.cidade, p.tribunal?.split('(')[0]?.trim()].filter(Boolean).join(' ¬∑ ')}</div>
                          )}
                        </td>
                        <td className="px-4 py-3 text-slate-600 text-xs">{(p.advogado||p.responsavel||'-').split(' ')[0]}</td>
                        <td className="px-4 py-3">
                          {p.prazo
                            ? <span className={`font-bold text-xs ${prazoVencido?'text-red-500':'text-orange-600'}`}>{new Date(p.prazo).toLocaleDateString('pt-BR')}</span>
                            : <span className="text-slate-300 text-xs">-</span>}
                        </td>
                        <td className="px-4 py-3">
                          <div className="text-xs text-slate-700">{renderFin(p)}</div>
                          <span className={`text-[10px] font-bold uppercase ${p.statusPagamento==='Pago'?'text-green-600':'text-orange-500'}`}>{p.statusPagamento}</span>
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex justify-center gap-2">
                            <button onClick={()=>{setFormData({...FORM_VAZIO,...p});setEditingId(p.id);setModal(true);}} className="text-blue-400 hover:text-navy"><Icons.Edit/></button>
                            {role!=='viewer' && <button onClick={()=>apagar(p.id,p.cliente)} className="text-slate-300 hover:text-red-500"><Icons.Trash/></button>}
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            <div className="px-4 py-2 border-t text-xs text-slate-400 bg-slate-50">
              {processosFiltrados.length} processo(s) exibido(s) ¬∑ {processos.length} total
            </div>
          </div>

          {/* ‚îÄ‚îÄ MODAL FORMUL√ÅRIO ‚îÄ‚îÄ */}
          {modal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 fade-in">
              <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[92vh]">

                {/* Header do modal */}
                <div className="bg-navy px-6 py-4 flex justify-between items-center shrink-0">
                  <div className="flex items-center gap-2 text-yellow-500">
                    <Icons.Scale/>
                    <h3 className="text-lg font-bold text-white tracking-wide">{editingId?'EDITAR PROCESSO':'NOVO CADASTRO'}</h3>
                  </div>
                  <button onClick={()=>{setModal(false);setEditingId(null);}} className="text-slate-400 hover:text-white"><Icons.X/></button>
                </div>

                <div className="p-5 overflow-y-auto custom-scrollbar space-y-4">

                  {/* CLIENTE */}
                  <div className="space-y-3">
                    <p className="text-[10px] font-bold text-navy uppercase tracking-wider border-b pb-1">Dados do Cliente</p>
                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Cliente *</label>
                      <input className="w-full p-2 border rounded bg-slate-50 font-bold text-slate-700" value={formData.cliente} onChange={e=>setF({cliente:e.target.value})}/>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">CPF</label>
                        <input className="w-full p-2 border rounded font-mono text-sm" value={formData.cpf} onChange={e=>setF({cpf:formatCPF(e.target.value)})}/>
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Telefone</label>
                        <input className="w-full p-2 border rounded text-sm" value={formData.telefone} onChange={e=>setF({telefone:formatPhone(e.target.value)})}/>
                      </div>
                    </div>
                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Parte Contr√°ria</label>
                      <input className="w-full p-2 border rounded text-sm" placeholder="R√©u / Autor / MP..." value={formData.parteContraria} onChange={e=>setF({parteContraria:e.target.value})}/>
                    </div>
                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Descri√ß√£o do Caso</label>
                      <textarea className="w-full p-2 border rounded text-sm h-16 resize-none" value={formData.descricao} onChange={e=>setF({descricao:e.target.value})}/>
                    </div>
                  </div>

                  {/* PROCESSO */}
                  <div className="space-y-3">
                    <p className="text-[10px] font-bold text-navy uppercase tracking-wider border-b pb-1">Processo</p>
                    <div className="flex items-center gap-3">
                      <label className="text-[10px] font-bold text-navy uppercase tracking-wider shrink-0">Ramo:</label>
                      <select className="p-1.5 border rounded text-sm font-bold text-navy bg-white" value={formData.ramo} onChange={e=>setF({ramo:e.target.value})}>
                        {MATERIAS.map(m=><option key={m.valor} value={m.valor}>{m.valor}</option>)}
                      </select>
                      <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${getChip(formData.ramo)}`}>{formData.ramo}</span>
                    </div>

                    {/* Campos espec√≠ficos Previdenci√°rio */}
                    {formData.ramo==='Previdenci√°rio' && (
                      <div className="bg-blue-50/60 p-4 rounded-xl border border-blue-100 space-y-3">
                        <h4 className="text-xs font-bold text-blue-800 uppercase flex items-center gap-2"><Icons.Users/> Previdenci√°rio</h4>
                        <div className="grid grid-cols-2 gap-3">
                          <div className="col-span-2">
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Patologia / Benef√≠cio</label>
                            <input className="w-full p-2 border rounded text-sm" value={formData.patologia} onChange={e=>setF({patologia:e.target.value})}/>
                          </div>
                          <div>
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Login GOV</label>
                            <input className="w-full p-2 border rounded text-sm font-mono bg-white" value={formData.govLogin} onChange={e=>setF({govLogin:e.target.value})}/>
                          </div>
                          <div>
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Senha GOV</label>
                            <input className="w-full p-2 border rounded text-sm font-mono bg-white" value={formData.govSenha} onChange={e=>setF({govSenha:e.target.value})}/>
                          </div>
                          <div>
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Per√≠cia M√©dica</label>
                            <input type="datetime-local" className="w-full p-2 border rounded text-sm" value={formData.dataPericia} onChange={e=>setF({dataPericia:e.target.value})}/>
                          </div>
                          <div>
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Avalia√ß√£o Social</label>
                            <input type="datetime-local" className="w-full p-2 border rounded text-sm" value={formData.dataSocial} onChange={e=>setF({dataSocial:e.target.value})}/>
                          </div>
                        </div>
                      </div>
                    )}

                    <div className="flex items-center gap-2">
                      <input type="checkbox" id="semProc" checked={formData.semProcesso} onChange={e=>setF({semProcesso:e.target.checked})}/>
                      <label htmlFor="semProc" className="text-xs text-slate-500 cursor-pointer">Ainda n√£o possui n¬∫ de processo</label>
                    </div>
                    {!formData.semProcesso && (
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase">N¬∫ Processo</label>
                        <input className="w-full p-2 border rounded font-mono text-sm" placeholder="0000000-00.0000.0.00.0000" value={formData.numeroProcesso} onChange={e=>setF({numeroProcesso:e.target.value})}/>
                      </div>
                    )}

                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase">Status Processual</label>
                      <select className="w-full p-2 border rounded text-sm bg-white" value={formData.statusProcessual} onChange={e=>setF({statusProcessual:e.target.value})}>
                        {STATUS_GRUPOS.map(g=>(
                          <optgroup key={g.grupo} label={g.grupo}>
                            {g.itens.map(s=><option key={s} value={s}>{s}</option>)}
                          </optgroup>
                        ))}
                      </select>
                    </div>
                  </div>

                  {/* LOCALIZA√á√ÉO */}
                  <div className="space-y-3">
                    <p className="text-[10px] font-bold text-navy uppercase tracking-wider border-b pb-1">Localiza√ß√£o & Tribunal</p>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase">Estado</label>
                        <select className="w-full p-2 border rounded text-sm bg-white" value={formData.estado} onChange={e=>setF({estado:e.target.value})}>
                          {Object.keys(ESTADOS_CIDADES).map(uf=><option key={uf} value={uf}>{uf}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase">Cidade</label>
                        <select className="w-full p-2 border rounded text-sm bg-white" value={formData.cidade} onChange={e=>setF({cidade:e.target.value})}>
                          {cidadesDaUF.map(c=><option key={c} value={c}>{c}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase">Sistema / Tribunal</label>
                        <select className="w-full p-2 border rounded text-sm bg-white" value={formData.tribunal} onChange={e=>setF({tribunal:e.target.value})}>
                          {TRIBUNAIS.map(g=>(
                            <optgroup key={g.grupo} label={g.grupo}>
                              {g.itens.map(t=><option key={t} value={t}>{t}</option>)}
                            </optgroup>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase">Vara / Ju√≠zo</label>
                        <input className="w-full p-2 border rounded text-sm" placeholder="Ex: 1¬™ Vara Criminal" value={formData.vara} onChange={e=>setF({vara:e.target.value})}/>
                      </div>
                    </div>
                  </div>

                  {/* ADVOGADO & PRAZO */}
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase">Advogado</label>
                      <select className="w-full p-2 border rounded text-sm bg-white" value={formData.advogado} onChange={e=>setF({advogado:e.target.value})}>
                        <option>Evison Nascimento</option>
                        <option>Adiellyson Bomfim</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-[10px] font-bold text-red-400 uppercase">Prazo Fatal</label>
                      <input type="date" className="w-full p-2 border rounded text-sm" value={formData.prazo} onChange={e=>setF({prazo:e.target.value})}/>
                    </div>
                  </div>

                  {/* DOCUMENTOS */}
                  <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <p className="text-[10px] font-bold text-slate-600 uppercase mb-3">Anexos (Links Nuvem)</p>
                    <div className="space-y-3">
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <input type="checkbox" id="proc" checked={formData.procuracaoEntregue} onChange={e=>setF({procuracaoEntregue:e.target.checked})}/>
                          <label htmlFor="proc" className="text-xs font-bold text-slate-500 cursor-pointer">Procura√ß√£o Entregue</label>
                        </div>
                        <input className="w-full p-2 border rounded text-xs bg-white text-blue-600" placeholder="Cole o link do Drive/OneDrive..." value={formData.linkProcuracao} onChange={e=>setF({linkProcuracao:e.target.value})}/>
                      </div>
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <input type="checkbox" id="contr" checked={formData.contratoEntregue} onChange={e=>setF({contratoEntregue:e.target.checked})}/>
                          <label htmlFor="contr" className="text-xs font-bold text-slate-500 cursor-pointer">Contrato Entregue</label>
                        </div>
                        <input className="w-full p-2 border rounded text-xs bg-white text-blue-600" placeholder="Cole o link do Drive/OneDrive..." value={formData.linkContrato} onChange={e=>setF({linkContrato:e.target.value})}/>
                      </div>
                    </div>
                  </div>

                  {/* HONOR√ÅRIOS */}
                  <div className="bg-orange-50/50 p-3 rounded-xl border border-orange-100">
                    <h4 className="text-xs font-bold text-orange-800 uppercase mb-3">Honor√°rios</h4>
                    <div className="grid grid-cols-2 gap-3 mb-3">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400">Tipo</label>
                        <select className="w-full p-2 border rounded text-sm bg-white" value={formData.tipoPagamento} onChange={e=>setF({tipoPagamento:e.target.value})}>
                          <option>Valor Cheio</option>
                          <option>Parcelado</option>
                          <option>√äxito</option>
                          <option>Misto</option>
                        </select>
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400">Status</label>
                        <select className="w-full p-2 border rounded text-sm bg-white" value={formData.statusPagamento} onChange={e=>setF({statusPagamento:e.target.value})}>
                          <option>Pendente</option>
                          <option>Pago</option>
                        </select>
                      </div>
                    </div>
                    {formData.tipoPagamento==='Valor Cheio' && (
                      <div>
                        <label className="text-[10px] font-bold text-slate-400">Valor Total</label>
                        <input className="w-full p-2 border rounded text-sm font-bold" placeholder="R$ 0,00" value={formData.valorContrato} onChange={e=>setF({valorContrato:e.target.value})}/>
                      </div>
                    )}
                    {formData.tipoPagamento==='Parcelado' && (
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="text-[10px] font-bold text-slate-400">Qtd. Parcelas</label>
                          <input type="number" className="w-full p-2 border rounded text-sm" value={formData.qtdParcelas} onChange={e=>setF({qtdParcelas:e.target.value})}/>
                        </div>
                        <div>
                          <label className="text-[10px] font-bold text-slate-400">Valor/Parcela</label>
                          <input className="w-full p-2 border rounded text-sm" placeholder="R$" value={formData.valorParcela} onChange={e=>setF({valorParcela:e.target.value})}/>
                        </div>
                      </div>
                    )}
                    {formData.tipoPagamento==='√äxito' && (
                      <div>
                        <label className="text-[10px] font-bold text-slate-400">Percentual sobre os ganhos (%)</label>
                        <input type="number" className="w-full p-2 border rounded text-sm" placeholder="Ex: 20" value={formData.percentualContrato} onChange={e=>setF({percentualContrato:e.target.value})}/>
                      </div>
                    )}
                    {formData.tipoPagamento==='Misto' && (
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="text-[10px] font-bold text-slate-400">Entrada (R$)</label>
                          <input type="number" className="w-full p-2 border rounded text-sm" value={formData.valorEntrada} onChange={e=>setF({valorEntrada:e.target.value})}/>
                        </div>
                        <div>
                          <label className="text-[10px] font-bold text-slate-400">Percentual (%)</label>
                          <input type="number" className="w-full p-2 border rounded text-sm" value={formData.percentualContrato} onChange={e=>setF({percentualContrato:e.target.value})}/>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Rodap√© do modal */}
                <div className="p-4 bg-slate-50 border-t flex gap-3 shrink-0">
                  <button onClick={()=>{setModal(false);setEditingId(null);}} className="flex-1 py-3 rounded-lg border text-slate-500 font-bold hover:bg-slate-100 transition">CANCELAR</button>
                  <button onClick={salvar} className="flex-[2] py-3 rounded-lg bg-navy text-white font-bold hover:bg-slate-800 shadow transition flex items-center justify-center gap-2">
                    <Icons.Check/> SALVAR
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUDITORIA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const AuditoriaView = ({ role, registrarLog }) => {
      const [logs, setLogs] = useState([]);
      useEffect(()=>{
        const unsub = db.collection(COL_AUDITORIA).orderBy('data','desc').limit(100).onSnapshot(
          snap=>setLogs(snap.docs.map(d=>({id:d.id,...d.data()}))), ()=>{}
        );
        return ()=>unsub();
      },[]);

      const limpar = async () => {
        if (role!=='master') return alert("Apenas o Mestre pode limpar.");
        if (!confirm("Apagar todo o hist√≥rico de auditoria?")) return;
        const batch = db.batch();
        const snap = await db.collection(COL_AUDITORIA).get();
        snap.forEach(doc=>batch.delete(doc.ref));
        await batch.commit();
        registrarLog("LIMPEZA","Auditoria limpa pelo Mestre.");
      };

      return (
        <div className="bg-white rounded-xl shadow-sm overflow-hidden fade-in">
          <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
            <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icons.History/> Auditoria do Sistema</h3>
            {role==='master' && (
              <button onClick={limpar} className="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded-lg font-bold hover:bg-red-200">LIMPAR TUDO</button>
            )}
          </div>
          <table className="w-full text-sm">
            <thead className="bg-slate-50 text-slate-400 text-xs font-bold uppercase border-b">
              <tr>
                <th className="px-5 py-3">Data / Hora</th>
                <th className="px-5 py-3">Usu√°rio</th>
                <th className="px-5 py-3">A√ß√£o</th>
                <th className="px-5 py-3">Detalhes</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {logs.map(l=>(
                <tr key={l.id} className="hover:bg-slate-50">
                  <td className="px-5 py-3 text-slate-400 font-mono text-xs">{new Date(l.data).toLocaleString('pt-BR')}</td>
                  <td className="px-5 py-3 font-bold text-slate-700">{l.usuario}</td>
                  <td className="px-5 py-3">
                    <span className={`px-2 py-1 rounded text-xs font-bold ${
                      l.acao==='LOGIN'?'bg-blue-50 text-blue-600':
                      l.acao?.includes('EXCLU')?'bg-red-50 text-red-600':
                      l.acao?.includes('CADASTRADO')?'bg-emerald-50 text-emerald-600':
                      'bg-slate-100 text-slate-500'}`}>{l.acao}</span>
                  </td>
                  <td className="px-5 py-3 text-slate-500 text-xs">{l.detalhe}</td>
                </tr>
              ))}
              {logs.length===0 && <tr><td colSpan="4" className="text-center py-12 text-slate-300">Sem registros de auditoria.</td></tr>}
            </tbody>
          </table>
        </div>
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  GEST√ÉO DE USU√ÅRIOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const UsuariosView = ({ registrarLog }) => {
      const [lista, setLista] = useState([]);
      const [novo, setNovo]   = useState({ nome:"", senha:"", role:"viewer" });

      const carregar = async () => {
        const snap = await db.collection(COL_USUARIOS).get();
        setLista(snap.docs.map(d=>({id:d.id,...d.data()})));
      };
      useEffect(()=>{ carregar(); },[]);

      const salvar = async () => {
        if (!novo.nome||!novo.senha) return alert("Preencha nome e senha.");
        await db.collection(COL_USUARIOS).doc(novo.nome).set({ senha:novo.senha, role:novo.role });
        alert("Usu√°rio salvo com sucesso!");
        setNovo({nome:"",senha:"",role:"viewer"}); carregar();
        registrarLog("GEST√ÉO USU√ÅRIO", `Criou/Editou: ${novo.nome} como ${novo.role}`);
      };

      const excluir = async id => {
        if (!confirm("Remover este usu√°rio?")) return;
        await db.collection(COL_USUARIOS).doc(id).delete();
        carregar(); registrarLog("GEST√ÉO USU√ÅRIO",`Removeu: ${id}`);
      };

      const roleTag = { master:'bg-purple-100 text-purple-700', admin:'bg-navy text-white', viewer:'bg-slate-100 text-slate-500' };

      return (
        <div className="space-y-6 fade-in">
          <div className="bg-white rounded-xl shadow-sm p-5">
            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icons.Users/> Adicionar / Editar Usu√°rio</h3>
            <div className="grid grid-cols-3 gap-3">
              <div>
                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nome de Usu√°rio</label>
                <input className="w-full p-2 border rounded text-sm" placeholder="nome.usuario" value={novo.nome} onChange={e=>setNovo({...novo,nome:e.target.value})}/>
              </div>
              <div>
                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Senha</label>
                <input type="text" className="w-full p-2 border rounded text-sm font-mono" value={novo.senha} onChange={e=>setNovo({...novo,senha:e.target.value})}/>
              </div>
              <div>
                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Permiss√£o</label>
                <select className="w-full p-2 border rounded text-sm bg-white" value={novo.role} onChange={e=>setNovo({...novo,role:e.target.value})}>
                  <option value="viewer">Viewer ‚Äì s√≥ leitura</option>
                  <option value="admin">Admin ‚Äì pode editar</option>
                </select>
              </div>
            </div>
            <button onClick={salvar} className="mt-3 bg-navy text-white px-4 py-2 rounded text-sm font-bold hover:bg-slate-800 flex items-center gap-2 transition">
              <Icons.Check/> Salvar Usu√°rio
            </button>
          </div>

          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            <div className="p-4 border-b bg-slate-50">
              <h3 className="font-bold text-slate-700">Usu√°rios Cadastrados</h3>
            </div>
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-400 text-xs uppercase font-bold border-b">
                <tr><th className="px-5 py-3">Usu√°rio</th><th className="px-5 py-3">Permiss√£o</th><th className="px-5 py-3 text-center">A√ß√µes</th></tr>
              </thead>
              <tbody className="divide-y">
                {lista.map(u=>(
                  <tr key={u.id} className="hover:bg-slate-50">
                    <td className="px-5 py-3 font-bold text-slate-700">{u.id}</td>
                    <td className="px-5 py-3"><span className={`text-xs font-bold px-2 py-1 rounded uppercase ${roleTag[u.role]||roleTag.viewer}`}>{u.role}</span></td>
                    <td className="px-5 py-3 text-center"><button onClick={()=>excluir(u.id)} className="text-slate-300 hover:text-red-500"><Icons.Trash/></button></td>
                  </tr>
                ))}
                {lista.length===0 && <tr><td colSpan="3" className="text-center py-8 text-slate-300">Nenhum usu√°rio cadastrado.</td></tr>}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  APP PRINCIPAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const AppContent = () => {
      const [authOk, setAuthOk]       = useState(false);
      const [socio, setSocio]         = useState("");
      const [nomeCompleto, setNomeCompleto] = useState("");
      const [role, setRole]           = useState("viewer");
      const [aba, setAba]             = useState('processos');
      const [privacidade, setPrivacidade] = useState(false);
      const [modalSenha, setModalSenha]   = useState(false);
      const [novaSenha, setNovaSenha]     = useState("");
      // Trigger para o bot√£o NOVO PROCESSO no header
      const [novoTrigger, setNovoTrigger] = useState(0);

      const registrarLog = useCallback(async (acao, detalhe) => {
        try { await db.collection(COL_AUDITORIA).add({ data: new Date().toISOString(), usuario: nomeCompleto||socio, acao, detalhe }); }
        catch(e) {}
      }, [nomeCompleto, socio]);

      const handleLogin = (nomeFull, r) => {
        setSocio(nomeFull.split(' ')[0]);
        setNomeCompleto(nomeFull);
        setRole(r);
        setAuthOk(true);
        setTimeout(()=>registrarLog("LOGIN", `Acesso como ${r.toUpperCase()}`), 1000);
      };

      const handleLogout = async () => {
        await registrarLog("LOGOUT","Sa√≠da do sistema.");
        window.location.reload();
      };

      const alterarSenha = async () => {
        if (role==='master') { alert("Senha mestre n√£o pode ser alterada aqui."); return; }
        if (!novaSenha||novaSenha.length<4) { alert("M√≠nimo 4 caracteres."); return; }
        try {
          await db.collection(COL_USUARIOS).doc(nomeCompleto).set({senha:novaSenha},{merge:true});
          await registrarLog("SEGURAN√áA","Alterou a pr√≥pria senha.");
          alert("Senha alterada com sucesso!"); setModalSenha(false); setNovaSenha("");
        } catch(e) { alert("Erro: "+e.message); }
      };

      useEffect(()=>{ if (authOk) auth.signInAnonymously().catch(()=>{}); },[authOk]);

      if (!authOk) return <LoginScreen onLogin={handleLogin}/>;

      const ABAS = [
        { id:'processos', label:'Processos', icon:'‚öñÔ∏è' },
        { id:'agenda',    label:'Agenda',    icon:'üìì' },
        { id:'auditoria', label:'Auditoria', icon:'üîç' },
        ...(role==='master' ? [{ id:'equipe', label:'Equipe', icon:'üë•' }] : []),
      ];

      const roleTagCls = { master:'tag-master', admin:'tag-admin', viewer:'tag-viewer' };

      return (
        <div className="min-h-screen pb-20 fade-in" style={{background:'#f8fafc'}}>

          {/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */}
          <header className="bg-white border-b sticky top-0 z-30 px-6 py-4 shadow-sm flex justify-between items-center no-print">
            {/* Logo */}
            <div className="flex items-center gap-3">
              <div className="text-yellow-600"><Icons.Scale/></div>
              <div>
                <h1 className="text-xl font-bold text-slate-900 font-serif leading-none">NB ADVOCACIA</h1>
                <div className="flex items-center gap-1.5">
                  <span className="text-xs font-bold text-slate-400 tracking-widest uppercase">Gest√£o Jur√≠dica</span>
                  <span className="text-slate-300">¬∑</span>
                  <span className="text-xs text-slate-500">{socio}</span>
                  <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase ${roleTagCls[role]||roleTagCls.viewer}`}>{role}</span>
                </div>
              </div>
            </div>

            {/* A√ß√µes */}
            <div className="flex gap-1 items-center flex-wrap justify-end">
              {/* Abas de navega√ß√£o */}
              {ABAS.map(a=>(
                <button key={a.id} onClick={()=>setAba(a.id)}
                  className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 transition
                    ${aba===a.id ? 'bg-navy text-white' : 'text-slate-500 hover:bg-slate-100'}`}>
                  <span>{a.icon}</span><span className="hidden md:inline">{a.label}</span>
                </button>
              ))}

              <div className="w-px h-5 bg-slate-200 mx-1"/>

              {/* Privacidade */}
              <button onClick={()=>setPrivacidade(!privacidade)} title={privacidade?"Mostrar Valores":"Ocultar Valores"}
                className="p-2 text-slate-400 hover:text-navy rounded-lg hover:bg-slate-100 transition">
                {privacidade ? <Icons.EyeOff/> : <Icons.Eye/>}
              </button>

              {/* Alterar senha */}
              {role!=='master' && (
                <button onClick={()=>setModalSenha(true)} title="Alterar Senha"
                  className="p-2 text-slate-400 hover:text-navy rounded-lg hover:bg-slate-100 transition">
                  <Icons.Key/>
                </button>
              )}

              {/* NOVO PROCESSO ‚Äì vis√≠vel s√≥ na aba processos */}
              {aba==='processos' && role!=='viewer' && (
                <button onClick={()=>setNovoTrigger(t=>t+1)}
                  className="bg-yellow-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-yellow-700 flex gap-2 items-center shadow transition-colors">
                  <Icons.Plus/><span className="hidden md:inline">NOVO PROCESSO</span>
                </button>
              )}

              {/* Logout */}
              <button onClick={handleLogout} title="Sair"
                className="p-2 text-slate-400 hover:text-red-500 rounded-lg hover:bg-slate-100 transition">
                <Icons.LogOut/>
              </button>
            </div>
          </header>

          {/* ‚îÄ‚îÄ CONTE√öDO ‚îÄ‚îÄ */}
          <main className="max-w-7xl mx-auto px-4 py-8">
            {aba==='processos' && (
              <ProcessosView
                socio={socio} role={role} privacidade={privacidade}
                registrarLog={registrarLog} novoTrigger={novoTrigger}
              />
            )}
            {aba==='agenda'    && <AgendaDiaria socio={socio} registrarLog={registrarLog}/>}
            {aba==='auditoria' && <AuditoriaView role={role} registrarLog={registrarLog}/>}
            {aba==='equipe' && role==='master' && <UsuariosView registrarLog={registrarLog}/>}
          </main>

          {/* ‚îÄ‚îÄ MODAL ALTERAR SENHA ‚îÄ‚îÄ */}
          {modalSenha && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 fade-in">
              <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden">
                <div className="bg-navy px-6 py-4 flex justify-between items-center">
                  <h3 className="text-lg font-bold text-white flex items-center gap-2"><Icons.Key/> Alterar Senha</h3>
                  <button onClick={()=>{setModalSenha(false);setNovaSenha("");}} className="text-slate-400 hover:text-white"><Icons.X/></button>
                </div>
                <div className="p-6 space-y-4">
                  <p className="text-sm text-slate-500">Defina uma nova senha para seu acesso.</p>
                  <input type="password" placeholder="Nova senha (m√≠n. 4 caracteres)"
                    className="w-full p-3 border rounded" value={novaSenha} onChange={e=>setNovaSenha(e.target.value)}/>
                  <div className="flex gap-3">
                    <button onClick={()=>{setModalSenha(false);setNovaSenha("");}}
                      className="flex-1 py-2.5 border rounded-lg text-slate-500 hover:bg-slate-50 font-medium text-sm">Cancelar</button>
                    <button onClick={alterarSenha}
                      className="flex-1 py-2.5 bg-navy rounded-lg text-white font-bold text-sm hover:bg-slate-800">Confirmar</button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ ERROR BOUNDARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false }; }
      static getDerivedStateFromError() { return { hasError: true }; }
      render() {
        if (this.state.hasError) return (
          <div className="min-h-screen flex items-center justify-center p-6">
            <div className="bg-white rounded-xl p-8 shadow text-center max-w-md">
              <div className="text-4xl mb-4">‚ö†Ô∏è</div>
              <h2 className="font-bold text-slate-800 text-lg mb-2">Erro Inesperado</h2>
              <p className="text-slate-500 text-sm mb-4">Ocorreu um erro na aplica√ß√£o.</p>
              <button onClick={()=>window.location.reload()} className="px-6 py-2 bg-navy text-white rounded-lg font-bold">Recarregar</button>
            </div>
          </div>
        );
        return this.props.children;
      }
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ErrorBoundary><AppContent/></ErrorBoundary>);
  </script>
</body>
</html>
