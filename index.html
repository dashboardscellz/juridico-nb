<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NB Advocacia - Gestão Jurídica v19.0</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; background-color: #f8fafc; overflow-x: hidden; }
    .bg-navy { background-color: #0f172a; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @media print { .no-print { display: none !important; } #print-area { visibility: visible; position: absolute; left: 0; top: 0; width: 100%; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyAP_VVV_tpGBpDMj77UFM3Z9QnqkdQafNY",
      authDomain: "juridico-nb.firebaseapp.com",
      projectId: "juridico-nb",
      storageBucket: "juridico-nb.firebasestorage.app",
      messagingSenderId: "1039744856084",
      appId: "1:1039744856084:web:75c32201c88da75c413701",
      measurementId: "G-TYQB8QGNG1"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    const COL_PROCESSOS = 'gestao_processos_nb';
    const COL_USUARIOS = 'credenciais_advocacia';
    const COL_AUDITORIA = 'auditoria_processos_nb';

    const CIDADES_PE = ["Recife", "Jaboatão", "Olinda", "Caruaru", "Petrolina", "Paulista", "Cabo", "Camaragibe", "Garanhuns", "Vitória", "Igarassu", "Goiana", "Gravatá", "Carpina", "Arcoverde"];
    const CIDADES_PB = ["João Pessoa", "Campina Grande", "Santa Rita", "Patos", "Bayeux", "Sousa", "Cajazeiras", "Cabedelo", "Guarabira", "Sapé"];

    const Icons = {
      Scale: () => <i data-lucide="scale" className="w-6 h-6"></i>,
      Plus: () => <i data-lucide="plus" className="w-4 h-4"></i>,
      LogOut: () => <i data-lucide="log-out" className="w-4 h-4"></i>,
      Key: () => <i data-lucide="key" className="w-4 h-4"></i>,
      X: () => <i data-lucide="x" className="w-5 h-5"></i>,
      Trash: () => <i data-lucide="trash-2" className="w-4 h-4"></i>,
      Edit: () => <i data-lucide="edit" className="w-4 h-4"></i>,
      Calculator: () => <i data-lucide="calculator" className="w-4 h-4"></i>,
      History: () => <i data-lucide="history" className="w-4 h-4"></i>,
      FileText: () => <i data-lucide="file-text" className="w-4 h-4"></i>
    };

    // Componente Calculadora Estilo Prazo Fácil
    const CalculatorModal = ({ onClose }) => {
      const [dataI, setDataI] = useState("");
      const [dias, setDias] = useState("");
      const [tipo, setTipo] = useState("uteis");
      const [estado, setEstado] = useState("PE");
      const [resultado, setResultado] = useState(null);

      const calcular = () => {
        if (!dataI || !dias) return;
        let dt = new Date(dataI);
        dt.setMinutes(dt.getMinutes() + dt.getTimezoneOffset());
        let cont = 0;
        while (cont < parseInt(dias)) {
          dt.setDate(dt.getDate() + 1);
          if (tipo === "uteis") {
            if (dt.getDay() !== 0 && dt.getDay() !== 6) cont++;
          } else cont++;
        }
        setResultado(dt.toLocaleDateString('pt-BR'));
      };

      return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-in">
          <div className="bg-white rounded-lg w-full max-w-md overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div className="p-4 flex justify-end border-b"><button onClick={onClose} className="text-slate-400 hover:text-red-500"><Icons.X/></button></div>
            <div className="p-6 overflow-y-auto custom-scrollbar space-y-4">
              <h3 className="text-center text-blue-900 font-bold uppercase text-sm">Insira os dados para calcular o prazo</h3>
              <select className="w-full p-2 border rounded" value={estado} onChange={e=>setEstado(e.target.value)}><option value="PE">Pernambuco</option><option value="PB">Paraíba</option></select>
              <select className="w-full p-2 border rounded"><option>Município</option>{(estado === "PE" ? CIDADES_PE : CIDADES_PB).map(c => <option key={c}>{c}</option>)}</select>
              <select className="w-full p-2 border rounded"><option>Matéria</option><option>Cível</option><option>Penal</option></select>
              <select className="w-full p-2 border rounded"><option value="Eletronico">Eletrônico</option><option value="Fisico">Físico</option></select>
              <select className="w-full p-2 border rounded"><option>Tribunal</option><option>TJ</option><option>TRF</option></select>
              <h3 className="text-center text-blue-900 font-bold uppercase text-sm mt-4">Insira a data da publicação</h3>
              <input type="date" className="w-full p-2 border rounded text-center" value={dataI} onChange={e=>setDataI(e.target.value)}/>
              <input type="number" className="w-full p-2 border rounded text-center" placeholder="Prazo em dias" value={dias} onChange={e=>setDias(e.target.value)}/>
              <div className="flex justify-center gap-6"><label><input type="radio" checked={tipo==="uteis"} onChange={()=>setTipo("uteis")}/> Úteis</label><label><input type="radio" checked={tipo==="corridos"} onChange={()=>setTipo("corridos")}/> Corridos</label></div>
              <button onClick={calcular} className="w-full bg-orange-600 text-white font-bold py-3 rounded hover:bg-orange-700">CALCULAR</button>
              {resultado && <div className="bg-green-100 p-4 rounded text-center font-bold text-green-800 text-2xl">{resultado}</div>}
            </div>
          </div>
        </div>
      );
    };

    const LoginScreen = ({ onLogin }) => {
      const [u, setU] = useState("");
      const [p, setP] = useState("");
      const [err, setErr] = useState("");

      const handle = async (e) => {
        e.preventDefault();
        if (u === "NB ADVOCACIA" && p === "NB07242530") { onLogin(u, "master"); return; }
        try {
          const doc = await db.collection(COL_USUARIOS).doc(u).get();
          if (doc.exists && doc.data().senha === p) onLogin(u, doc.data().role || "viewer");
          else setErr("Dados incorretos.");
        } catch(e) { setErr("Erro de conexão."); }
      };

      return (
        <div className="min-h-screen bg-navy flex items-center justify-center p-4">
          <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 className="text-2xl font-bold text-center mb-6">NB ADVOCACIA</h2>
            <form onSubmit={handle} className="space-y-4">
              <input className="w-full p-3 border rounded" placeholder="Usuário" value={u} onChange={e=>setU(e.target.value)}/>
              <input type="password" className="w-full p-3 border rounded" placeholder="Senha" value={p} onChange={e=>setP(e.target.value)}/>
              {err && <p className="text-red-500 text-sm text-center">{err}</p>}
              <button className="w-full bg-navy text-white py-3 rounded font-bold">ENTRAR</button>
            </form>
          </div>
        </div>
      );
    };

    const App = () => {
      const [authOk, setAuthOk] = useState(false);
      const [user, setUser] = useState("");
      const [role, setRole] = useState("viewer");
      const [aba, setAba] = useState("processos");
      const [processos, setProcessos] = useState([]);
      const [logs, setLogs] = useState([]);
      const [modal, setModal] = useState(false);
      const [calc, setCalc] = useState(false);
      const [ficha, setFicha] = useState(null);
      const [editId, setEditId] = useState(null);
      const [busca, setBusca] = useState("");

      const [form, setForm] = useState({ cliente: "", cpf: "", ramo: "Cível", statusProcessual: "Em Andamento", advogado: "Evison Nascimento", statusPagamento: "Pendente" });

      useEffect(() => {
        const handleEsc = (e) => { if (e.key === 'Escape') { setModal(false); setCalc(false); setFicha(null); } };
        window.addEventListener('keydown', handleEsc);
        lucide.createIcons();
        return () => window.removeEventListener('keydown', handleEsc);
      }, []);

      useEffect(() => {
        if (!authOk) return;
        auth.signInAnonymously();
        return db.collection(COL_PROCESSOS).onSnapshot(s => setProcessos(s.docs.map(d => ({id: d.id, ...d.data()}))));
      }, [authOk]);

      useEffect(() => {
        if (aba === "auditoria") db.collection(COL_AUDITORIA).orderBy('data','desc').limit(50).onSnapshot(s => setLogs(s.docs.map(d => ({id: d.id, ...d.data()}))));
      }, [aba]);

      const registrarLog = (acao, det) => {
        db.collection(COL_AUDITORIA).add({ data: new Date().toISOString(), usuario: user, acao, detalhe: det });
      };

      const salvar = async () => {
        if (!form.cliente) return alert("Nome do cliente obrigatório");
        if (editId) await db.collection(COL_PROCESSOS).doc(editId).update(form);
        else await db.collection(COL_PROCESSOS).add({...form, criadoEm: new Date().toISOString()});
        registrarLog(editId ? "EDIÇÃO" : "CRIAÇÃO", form.cliente);
        setModal(false); setEditId(null);
      };

      if (!authOk) return <LoginScreen onLogin={(u,r)=>{setUser(u);setRole(r);setAuthOk(true);}} />;

      return (
        <div className="min-h-screen pb-10">
          <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50">
            <h1 className="font-bold text-navy">NB ADVOCACIA</h1>
            <div className="flex gap-2">
              <button onClick={()=>setAba("dashboard")} className={`px-3 py-1 rounded text-sm ${aba==="dashboard"?"bg-navy text-white":"text-slate-500"}`}>Dash</button>
              <button onClick={()=>setAba("processos")} className={`px-3 py-1 rounded text-sm ${aba==="processos"?"bg-navy text-white":"text-slate-500"}`}>Processos</button>
              <button onClick={()=>setCalc(true)} className="p-2 bg-slate-100 rounded hover:bg-slate-200"><Icons.Calculator/></button>
              {role !== "viewer" && <button onClick={()=>{setEditId(null);setForm({cliente:"",ramo:"Cível",statusProcessual:"Em Andamento",advogado:"Evison Nascimento",statusPagamento:"Pendente"});setModal(true);}} className="bg-yellow-600 text-white px-4 py-1 rounded font-bold"><Icons.Plus/></button>}
              <button onClick={()=>window.location.reload()} className="p-2 text-red-500"><Icons.LogOut/></button>
            </div>
          </header>

          <main className="max-w-7xl mx-auto p-6">
            {calc && <CalculatorModal onClose={()=>setCalc(false)}/>}
            
            {aba === "processos" && (
              <div className="bg-white rounded-lg shadow overflow-hidden">
                <div className="p-4 border-b bg-slate-50"><input type="text" placeholder="Buscar cliente..." className="w-full p-2 border rounded" value={busca} onChange={e=>setBusca(e.target.value)}/></div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left">
                    <thead className="bg-slate-100 font-bold"><tr><th className="p-3">Cliente</th><th className="p-3">Ramo</th><th className="p-3">Status</th><th className="p-3">Ações</th></tr></thead>
                    <tbody className="divide-y">
                      {processos.filter(p=>p.cliente.toLowerCase().includes(busca.toLowerCase())).map(p => (
                        <tr key={p.id} className="hover:bg-slate-50">
                          <td className="p-3 font-bold">{p.cliente}</td>
                          <td className="p-3">{p.ramo}</td>
                          <td className="p-3"><span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">{p.statusProcessual}</span></td>
                          <td className="p-3 flex gap-2">
                            <button onClick={()=>{setEditId(p.id);setForm(p);setModal(true);}} className="text-blue-500"><Icons.Edit/></button>
                            {role !== "viewer" && <button onClick={()=>{if(confirm("Excluir?")) db.collection(COL_PROCESSOS).doc(p.id).delete();}} className="text-red-400"><Icons.Trash/></button>}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </main>

          {modal && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 p-4 fade-in">
              <div className="bg-white rounded-lg w-full max-w-lg overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
                <div className="bg-navy text-white p-4 flex justify-between"><h3>{editId?"EDITAR":"NOVO"} PROCESSO</h3><button onClick={()=>setModal(false)}><Icons.X/></button></div>
                <div className="p-6 overflow-y-auto custom-scrollbar space-y-4">
                  <div><label className="text-xs font-bold text-slate-400 block mb-1">CLIENTE</label><input className="w-full p-2 border rounded" value={form.cliente} onChange={e=>setForm({...form, cliente: e.target.value})}/></div>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="text-xs font-bold text-slate-400 block mb-1">RAMO</label><select className="w-full p-2 border rounded" value={form.ramo} onChange={e=>setForm({...form, ramo: e.target.value})}>
                      {["Cível", "Previdenciário", "Trabalhista", "Penal"].map(r=><option key={r}>{r}</option>)}
                    </select></div>
                    <div><label className="text-xs font-bold text-slate-400 block mb-1">RESPONSÁVEL</label><select className="w-full p-2 border rounded" value={form.advogado} onChange={e=>setForm({...form, advogado: e.target.value})}>
                      <option>Evison Nascimento</option><option>Adiellyson Bomfim</option>
                    </select></div>
                  </div>
                  {form.ramo === "Previdenciário" && <div className="bg-blue-50 p-4 rounded border border-blue-100 space-y-2"><p className="text-xs font-bold text-blue-800">DADOS PREVIDENCIÁRIOS</p><input className="w-full p-2 border rounded bg-white" placeholder="Login GOV" value={form.govLogin} onChange={e=>setForm({...form, govLogin: e.target.value})}/><input className="w-full p-2 border rounded bg-white" placeholder="Senha GOV" value={form.govSenha} onChange={e=>setForm({...form, govSenha: e.target.value})}/></div>}
                </div>
                <div className="p-4 border-t bg-slate-50 flex gap-2"><button onClick={()=>setModal(false)} className="flex-1 py-2 border rounded">CANCELAR</button><button onClick={salvar} className="flex-1 py-2 bg-navy text-white rounded font-bold">SALVAR</button></div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>