<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nascimento & Bomfim - Sistema Jur√≠dico v3.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap');

    :root {
      --navy: #1e293b;
      --gold: #b49b67;
      --gold-light: #d4bc8a;
      --cream: #faf8f4;
    }

    * { box-sizing: border-box; }
    body { font-family: 'DM Sans', system-ui, sans-serif; background-color: var(--cream); }
    h1, h2, h3, h4, .font-serif { font-family: 'Playfair Display', Georgia, serif !important; }

    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .slide-in { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

    .bg-navy { background-color: var(--navy); }
    .text-gold { color: var(--gold); }
    .bg-gold { background-color: var(--gold); }
    .border-gold { border-color: var(--gold); }
    .text-navy { color: var(--navy); }
    .hover-gold:hover { color: var(--gold); }
    .focus-gold:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 0 2px rgba(180,155,103,0.2); }

    /* Tags de Permiss√£o */
    .tag-master { background-color: #7e22ce; color: white; }
    .tag-admin { background-color: var(--navy); color: white; }
    .tag-viewer { background-color: #94a3b8; color: white; }

    /* ===== CORES DAS MAT√âRIAS ===== */
    .materia-criminal    { background-color: #fef2f2; color: #b91c1c; border-left: 3px solid #ef4444; }
    .materia-previdenciario { background-color: #f0fdf4; color: #15803d; border-left: 3px solid #22c55e; }
    .materia-civel       { background-color: #eff6ff; color: #1d4ed8; border-left: 3px solid #3b82f6; }
    .materia-trabalhista { background-color: #f8fafc; color: #475569; border-left: 3px solid #94a3b8; }
    .materia-familia     { background-color: #fdf2f8; color: #be185d; border-left: 3px solid #ec4899; }
    .materia-tributario  { background-color: #fff7ed; color: #c2410c; border-left: 3px solid #f97316; }
    .materia-administrativo { background-color: #faf5ff; color: #7e22ce; border-left: 3px solid #a855f7; }
    .materia-empresarial { background-color: #eef2ff; color: #3730a3; border-left: 3px solid #6366f1; }
    .materia-consumidor  { background-color: #f0fdfa; color: #0f766e; border-left: 3px solid #14b8a6; }
    .materia-ambiental   { background-color: #f7fee7; color: #4d7c0f; border-left: 3px solid #84cc16; }
    .materia-imobiliario { background-color: #fefce8; color: #a16207; border-left: 3px solid #eab308; }
    .materia-default     { background-color: #f8fafc; color: #475569; border-left: 3px solid #cbd5e1; }

    /* Badge chips */
    .chip-criminal    { background-color: #fee2e2; color: #b91c1c; }
    .chip-previdenciario { background-color: #dcfce7; color: #15803d; }
    .chip-civel       { background-color: #dbeafe; color: #1d4ed8; }
    .chip-trabalhista { background-color: #f1f5f9; color: #475569; }
    .chip-familia     { background-color: #fce7f3; color: #be185d; }
    .chip-tributario  { background-color: #ffedd5; color: #c2410c; }
    .chip-administrativo { background-color: #f3e8ff; color: #7e22ce; }
    .chip-empresarial { background-color: #e0e7ff; color: #3730a3; }
    .chip-consumidor  { background-color: #ccfbf1; color: #0f766e; }
    .chip-ambiental   { background-color: #ecfccb; color: #4d7c0f; }
    .chip-imobiliario { background-color: #fef9c3; color: #a16207; }
    .chip-default     { background-color: #f1f5f9; color: #64748b; }

    /* Agenda task styles */
    .task-item { transition: all 0.2s ease; }
    .task-item:hover { background-color: #f8f9fa; }
    .task-done .task-text { text-decoration: line-through; color: #94a3b8; }
    .priority-alta  { border-left: 3px solid #ef4444; }
    .priority-media { border-left: 3px solid #f59e0b; }
    .priority-baixa { border-left: 3px solid #10b981; }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

    /* Print */
    @media print {
      body { background-color: white; }
      header, .no-print, button { display: none !important; }
      .shadow-sm, .shadow-2xl { box-shadow: none !important; }
      .print-break { page-break-inside: avoid; }
    }

    /* Input/Select styling */
    input, select, textarea {
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--gold) !important;
      outline: none;
      box-shadow: 0 0 0 2px rgba(180,155,103,0.15);
    }

    /* Modal backdrop */
    .modal-backdrop { backdrop-filter: blur(4px); }

    /* Nav pill */
    .nav-pill { transition: all 0.2s ease; border-radius: 6px; }
    .nav-pill.active { background-color: var(--navy); color: white; }
    .nav-pill:not(.active):hover { background-color: #f1f5f9; }

    /* Card hover */
    .card-hover { transition: box-shadow 0.2s, transform 0.2s; }
    .card-hover:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); transform: translateY(-1px); }

    /* Progress bar */
    .progress-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useRef, useCallback, Component } = React;

// ============================================================
// ‚ö†Ô∏è FIREBASE CONFIG
// ============================================================
const firebaseConfig = {
  apiKey: "AIzaSyCC1jE63rpMAu_5rfCe5IVhB_ysYCo1bd0",
  authDomain: "ab-advocacia.firebaseapp.com",
  projectId: "ab-advocacia",
  storageBucket: "ab-advocacia.firebasestorage.app",
  messagingSenderId: "662748092004",
  appId: "1:662748092004:web:c62513a867eb486ac6b171",
  measurementId: "G-9380LF0TYF"
};

if (!firebase.apps.length) {
  try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
}
const db = firebase.firestore();
const auth = firebase.auth();

// ============================================================
// DADOS EST√ÅTICOS - MAT√âRIAS, STATUS, CIDADES, TRIBUNAIS
// ============================================================

const MATERIAS = [
  { valor: "Criminal",       label: "Criminal",              chip: "chip-criminal",       row: "materia-criminal" },
  { valor: "C√≠vel",          label: "C√≠vel",                 chip: "chip-civel",          row: "materia-civel" },
  { valor: "Previdenci√°rio", label: "Previdenci√°rio",        chip: "chip-previdenciario", row: "materia-previdenciario" },
  { valor: "Trabalhista",    label: "Direito do Trabalho",   chip: "chip-trabalhista",    row: "materia-trabalhista" },
  { valor: "Fam√≠lia",        label: "Direito de Fam√≠lia",    chip: "chip-familia",        row: "materia-familia" },
  { valor: "Tribut√°rio",     label: "Tribut√°rio / Fiscal",   chip: "chip-tributario",     row: "materia-tributario" },
  { valor: "Administrativo", label: "Direito Administrativo",chip: "chip-administrativo", row: "materia-administrativo" },
  { valor: "Empresarial",    label: "Empresarial / Comercial",chip:"chip-empresarial",    row: "materia-empresarial" },
  { valor: "Consumidor",     label: "Direito do Consumidor", chip: "chip-consumidor",     row: "materia-consumidor" },
  { valor: "Ambiental",      label: "Direito Ambiental",     chip: "chip-ambiental",      row: "materia-ambiental" },
  { valor: "Imobili√°rio",    label: "Direito Imobili√°rio",   chip: "chip-imobiliario",    row: "materia-imobiliario" },
  { valor: "Outro",          label: "Outro",                 chip: "chip-default",        row: "materia-default" },
];

const getMateriaInfo = (valor) => MATERIAS.find(m => m.valor === valor) || MATERIAS[MATERIAS.length - 1];

const STATUS_PROCESSO = [
  { grupo: "üìã Fase Inicial", itens: [
    "Aguardando protocolo",
    "Protocolado",
    "Aguardando cita√ß√£o / intima√ß√£o",
    "Citado ‚Äì aguardando prazo",
  ]},
  { grupo: "‚öñÔ∏è Fase de Conhecimento", itens: [
    "Em andamento",
    "Em resposta √† acusa√ß√£o",
    "Em contesta√ß√£o",
    "Em r√©plica",
    "Em tr√©plica",
    "Em contraraz√µes",
    "Em fase de instru√ß√£o",
    "Audi√™ncia designada",
    "Aguardando designa√ß√£o de audi√™ncia",
    "Em fase probat√≥ria",
    "Aguardando laudo pericial",
    "Em per√≠cia",
    "Concluso para senten√ßa",
  ]},
  { grupo: "üîç Fase Investigativa (Criminal)", itens: [
    "Em inqu√©rito policial",
    "Inqu√©rito arquivado",
    "Em investiga√ß√£o preliminar",
    "Em habeas corpus",
    "Em habeas data",
    "Em liberdade provis√≥ria",
    "Em pris√£o preventiva",
    "Em sursis processual",
    "R√©u preso ‚Äì aguardando julgamento",
  ]},
  { grupo: "üì£ Recursos", itens: [
    "Em recurso",
    "Em apela√ß√£o",
    "Em agravo de instrumento",
    "Em agravo regimental / interno",
    "Em embargos de declara√ß√£o",
    "Em embargos infringentes",
    "Em recurso especial ‚Äì STJ",
    "Em recurso extraordin√°rio ‚Äì STF",
    "Em mandado de seguran√ßa",
    "Em revis√£o criminal",
    "Em a√ß√£o rescis√≥ria",
  ]},
  { grupo: "‚úÖ Cumprimento / Execu√ß√£o", itens: [
    "Transitado em julgado",
    "Em cumprimento de senten√ßa",
    "Em execu√ß√£o fiscal",
    "Em execu√ß√£o penal",
    "Aguardando precat√≥rio / RPV",
    "Em acordo / concilia√ß√£o",
    "Extinto com resolu√ß√£o do m√©rito",
    "Extinto sem resolu√ß√£o do m√©rito",
  ]},
  { grupo: "üóÇÔ∏è Encerrado", itens: [
    "Arquivado",
    "Suspenso",
    "Cancelado",
  ]},
];

const STATUS_FLAT = STATUS_PROCESSO.flatMap(g => g.itens);

const ESTADOS_CIDADES = {
  "PE ‚Äì Pernambuco": [
    "Recife","Caruaru","Petrolina","Olinda","Paulista","Garanhuns","Cama√ßari",
    "Jaboat√£o dos Guararapes","Cabo de Santo Agostinho","Vit√≥ria de Santo Ant√£o",
    "Arcoverde","Serra Talhada","Santa Cruz do Capibaribe","Carpina","Surubim",
  ],
  "PB ‚Äì Para√≠ba": [
    "Jo√£o Pessoa","Campina Grande","Patos","Guarabira","Cajazeiras",
    "Sousa","Bayeux","Santa Rita","Monteiro","Pombal",
  ],
  "AL ‚Äì Alagoas": [
    "Macei√≥","Arapiraca","Palmeira dos √çndios","Rio Largo","Penedo","Uni√£o dos Palmares",
  ],
  "BA ‚Äì Bahia": [
    "Salvador","Feira de Santana","Vit√≥ria da Conquista","Ilh√©us","Itabuna",
    "Barreiras","Juazeiro","Cama√ßari","Alagoinhas","Santo Ant√¥nio de Jesus",
    "Porto Seguro","Paulo Afonso","Eun√°polis","Jequi√©",
  ],
  "RS ‚Äì Rio Grande do Sul": [
    "Porto Alegre","Caxias do Sul","Pelotas","Santa Maria","Novo Hamburgo",
    "S√£o Leopoldo","Gravata√≠","Canoas","Passo Fundo","Uruguaiana",
    "Rio Grande","Bag√©","Bento Gon√ßalves","Lajeado","Cachoeirinha",
  ],
  "SP ‚Äì S√£o Paulo": [
    "S√£o Paulo","Campinas","Santos","Ribeir√£o Preto","Sorocaba",
    "Osasco","Guarulhos","Santo Andr√©","Mau√°","S√£o Bernardo do Campo",
  ],
  "RJ ‚Äì Rio de Janeiro": [
    "Rio de Janeiro","Niter√≥i","Duque de Caxias","Nova Igua√ßu","Campos dos Goytacazes",
  ],
  "MG ‚Äì Minas Gerais": [
    "Belo Horizonte","Uberl√¢ndia","Contagem","Juiz de Fora","Betim",
  ],
  "CE ‚Äì Cear√°": [
    "Fortaleza","Caucaia","Juazeiro do Norte","Maracana√∫","Sobral",
  ],
  "PI ‚Äì Piau√≠": [
    "Teresina","Parna√≠ba","Floriano","Piripiri",
  ],
  "RN ‚Äì Rio Grande do Norte": [
    "Natal","Mossor√≥","Parnamirim","Caic√≥",
  ],
  "SE ‚Äì Sergipe": [
    "Aracaju","Lagarto","Itabaiana","Nossa Senhora do Socorro",
  ],
  "MA ‚Äì Maranh√£o": [
    "S√£o Lu√≠s","Imperatriz","Timon","Caxias",
  ],
  "DF ‚Äì Distrito Federal": ["Bras√≠lia"],
  "GO ‚Äì Goi√°s": ["Goi√¢nia","Aparecida de Goi√¢nia","An√°polis"],
  "MT ‚Äì Mato Grosso": ["Cuiab√°","V√°rzea Grande","Rondon√≥polis"],
  "MS ‚Äì Mato Grosso do Sul": ["Campo Grande","Dourados","Tr√™s Lagoas"],
  "PR ‚Äì Paran√°": ["Curitiba","Londrina","Maring√°","Ponta Grossa"],
  "SC ‚Äì Santa Catarina": ["Florian√≥polis","Joinville","Blumenau","Chapec√≥"],
  "PA ‚Äì Par√°": ["Bel√©m","Ananindeua","Santar√©m"],
  "AM ‚Äì Amazonas": ["Manaus","Parintins"],
};

const TRIBUNAIS_SISTEMAS = [
  { grupo: "üèõÔ∏è Estaduais (PJE)", itens: [
    "PJE-PE (TJ-PE)","PJE-PB (TJ-PB)","PJE-AL (TJ-AL)","PJE-BA (TJ-BA)",
    "PJE-RS (TJ-RS)","PJE-RN (TJ-RN)","PJE-CE (TJ-CE)","PJE-PI (TJ-PI)",
    "PJE-SE (TJ-SE)","PJE-MA (TJ-MA)","PJE-GO (TJ-GO)","PJE-PR (TJ-PR)",
    "PJE-SC (TJ-SC)","PJE-MT (TJ-MT)","PJE-MS (TJ-MS)","PJE-PA (TJ-PA)",
  ]},
  { grupo: "üèõÔ∏è Estaduais (Outros)", itens: [
    "ESAJ-SP (TJ-SP)","ESAJ-SC (TJ-SC)","ESAJ-RJ (TJ-RJ)",
    "PROJUDI-PR (TJ-PR)","SEEU (Execu√ß√£o Penal)",
  ]},
  { grupo: "‚öñÔ∏è Justi√ßa Federal", itens: [
    "E-PROC (TRF1)","E-PROC (TRF4 ‚Äì RS/SC/PR)","PROC (JF)",
    "PJE-JF (TRF2)","PJE-JF (TRF3)","PJE-JF (TRF5)",
  ]},
  { grupo: "üë∑ Justi√ßa do Trabalho", itens: [
    "PJE-TRT1 (RJ)","PJE-TRT2 (SP)","PJE-TRT4 (RS)","PJE-TRT6 (PE)",
    "PJE-TRT7 (CE)","PJE-TRT13 (PB)","PJE-TRT18 (GO)","PJE-TRT19 (AL)","PJE-TRT20 (SE)",
  ]},
  { grupo: "üî∫ Tribunais Superiores", itens: [
    "STJ ‚Äì Superior Tribunal de Justi√ßa",
    "STF ‚Äì Supremo Tribunal Federal",
    "TST ‚Äì Tribunal Superior do Trabalho",
    "TSE ‚Äì Tribunal Superior Eleitoral",
    "STM ‚Äì Superior Tribunal Militar",
  ]},
  { grupo: "üîç Investiga√ß√£o / Inqu√©rito", itens: [
    "Delegacia Civil","Delegacia Federal (DPF)","GAECO","Minist√©rio P√∫blico Estadual","Minist√©rio P√∫blico Federal",
  ]},
  { grupo: "üè¢ Administrativo", itens: [
    "CEJUSC (Concilia√ß√£o)","PROCON","ANATEL","BACEN","SUSEP","ANVISA","CADE",
  ]},
];

const TRIBUNAIS_FLAT = TRIBUNAIS_SISTEMAS.flatMap(g => g.itens);

// ============================================================
// √çCONES
// ============================================================
const Icons = {
  Plus:     () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>,
  Trash:    () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
  Scale:    () => <svg className="w-7 h-7" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>,
  LogOut:   () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
  History:  () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
  Search:   () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
  Target:   () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
  TrendUp:  () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>,
  Key:      () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>,
  Excel:    () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>,
  Eye:      () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>,
  EyeOff:   () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>,
  Clock:    () => <svg className="w-3 h-3" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
  Check:    () => <svg className="w-3 h-3" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7"/></svg>,
  Users:    () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
  Briefcase:() => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>,
  Calendar: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
  ChevLeft: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7"/></svg>,
  ChevRight:() => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7"/></svg>,
  Move:     () => <svg className="w-3 h-3" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>,
  Flag:     () => <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>,
  Percent:  () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 14L15 8M9.5 9a.5.5 0 110-1 .5.5 0 010 1zm5 5a.5.5 0 110-1 .5.5 0 010 1z"/><circle cx="12" cy="12" r="9"/></svg>,
  Edit:     () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>,
};

// ============================================================
// GR√ÅFICO
// ============================================================
const FinanceChart = ({ data, type }) => {
  const canvasRef = useRef(null);
  const chartInstance = useRef(null);
  useEffect(() => {
    if (!canvasRef.current || !window.Chart) return;
    if (chartInstance.current) chartInstance.current.destroy();
    try {
      const ctx = canvasRef.current.getContext('2d');
      const config = type === 'bar' ? {
        type: 'bar',
        data: {
          labels: ['Receita', 'Despesa', 'L√≠quido'],
          datasets: [{ label: 'R$', data: [data.receita, data.despesa, data.liquido], backgroundColor: ['#10b981', '#ef4444', '#1e293b'], borderRadius: 6 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } } } }
      } : {
        type: 'doughnut',
        data: {
          labels: ['Evison', 'Adiellyson', 'Escrit√≥rio'],
          datasets: [{ data: [data.graficoPizza[0].value, data.graficoPizza[1].value, data.graficoPizza[2].value], backgroundColor: ['#1e293b', '#b49b67', '#94a3b8'], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      };
      chartInstance.current = new Chart(ctx, config);
    } catch (err) { console.error(err); }
    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
  }, [data, type]);
  return <canvas ref={canvasRef} />;
};

// ============================================================
// LOGIN
// ============================================================
const LoginScreen = ({ onLogin }) => {
  const [user, setUser] = useState("");
  const [pass, setPass] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const [showPass, setShowPass] = useState(false);

  const handle = async (e) => {
    e.preventDefault();
    setLoading(true); setError("");
    if (user === "NB ADVOCACIA" && pass === "NB07242530") { onLogin(user, "master"); return; }
    if (db) {
      try {
        const docRef = db.collection('credenciais_advocacia').doc(user);
        const docSnap = await docRef.get();
        if (docSnap.exists) {
          const data = docSnap.data();
          if (data.senha === pass) { onLogin(user, data.role || 'viewer'); return; }
          else setError("Senha incorreta.");
        } else setError("Usu√°rio n√£o cadastrado.");
      } catch (err) { setError("Erro de conex√£o. Tente novamente."); }
    }
    setLoading(false);
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4" style={{background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 60%, #1a2540 100%)'}}>
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div style={{position:'absolute',top:'20%',left:'10%',width:'300px',height:'300px',background:'rgba(180,155,103,0.04)',borderRadius:'50%',filter:'blur(60px)'}}/>
        <div style={{position:'absolute',bottom:'20%',right:'10%',width:'400px',height:'400px',background:'rgba(180,155,103,0.03)',borderRadius:'50%',filter:'blur(80px)'}}/>
      </div>
      <div className="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-8 fade-in relative">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-14 h-14 rounded-full mb-4" style={{background:'#1e293b'}}>
            <span className="text-gold"><Icons.Scale /></span>
          </div>
          <h2 className="text-2xl font-bold text-slate-800" style={{fontFamily:'Playfair Display, serif'}}>NASCIMENTO & BOMFIM</h2>
          <p className="text-xs text-slate-400 uppercase tracking-widest mt-1">Advocacia & Consultoria Jur√≠dica</p>
        </div>
        <form onSubmit={handle} className="space-y-4">
          <div>
            <label className="text-xs font-bold text-slate-500 uppercase tracking-wide block mb-1">Usu√°rio</label>
            <input className="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="Nome do usu√°rio" value={user} onChange={e => setUser(e.target.value)} />
          </div>
          <div className="relative">
            <label className="text-xs font-bold text-slate-500 uppercase tracking-wide block mb-1">Senha</label>
            <input type={showPass ? "text" : "password"} className="w-full p-3 border border-slate-200 rounded-lg text-sm pr-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={pass} onChange={e => setPass(e.target.value)} />
            <button type="button" onClick={() => setShowPass(!showPass)} className="absolute right-3 top-8 text-slate-400 hover:text-slate-600">
              {showPass ? <Icons.EyeOff /> : <Icons.Eye />}
            </button>
          </div>
          {error && <div className="bg-red-50 border border-red-200 text-red-600 text-sm px-3 py-2 rounded-lg">{error}</div>}
          <button disabled={loading} className="w-full py-3 rounded-lg font-bold text-sm tracking-wide transition hover:opacity-90 active:scale-95" style={{background:'#1e293b', color:'white'}}>
            {loading ? <span className="flex items-center justify-center gap-2"><span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin inline-block"/> VERIFICANDO...</span> : 'ENTRAR'}
          </button>
        </form>
        <p className="text-center text-xs text-slate-300 mt-6">√Årea Restrita ¬∑ v3.0</p>
      </div>
    </div>
  );
};

// ============================================================
// COMPONENTE: AGENDA DI√ÅRIA
// ============================================================
const AgendaDiaria = ({ socio, db, registrarLog }) => {
  const hoje = new Date().toISOString().split('T')[0];
  const [dataSel, setDataSel] = useState(hoje);
  const [tarefas, setTarefas] = useState([]);
  const [notas, setNotas] = useState("");
  const [novaTarefa, setNovaTarefa] = useState({ texto: "", hora: "", prioridade: "media" });
  const [loading, setLoading] = useState(false);
  const [salvando, setSalvando] = useState(false);
  const notasTimeout = useRef(null);

  const docId = `agenda_${dataSel.replace(/-/g, '')}`;

  const carregar = async (data) => {
    if (!db) return;
    setLoading(true);
    try {
      const doc = await db.collection('agenda_advocacia').doc(`agenda_${data.replace(/-/g, '')}`).get();
      if (doc.exists) {
        const d = doc.data();
        setTarefas(d.tarefas || []);
        setNotas(d.notas || "");
      } else {
        setTarefas([]);
        setNotas("");
      }
    } catch (e) { console.error(e); }
    setLoading(false);
  };

  useEffect(() => { carregar(dataSel); }, [dataSel]);

  const salvarAgenda = async (novasTarefas, novaNota) => {
    if (!db) return;
    setSalvando(true);
    try {
      await db.collection('agenda_advocacia').doc(docId).set({
        data: dataSel,
        tarefas: novasTarefas !== undefined ? novasTarefas : tarefas,
        notas: novaNota !== undefined ? novaNota : notas,
        atualizadoEm: new Date().toISOString(),
        usuario: socio,
      });
    } catch (e) { console.error(e); }
    setTimeout(() => setSalvando(false), 600);
  };

  const adicionarTarefa = async () => {
    if (!novaTarefa.texto.trim()) return;
    const t = { id: Date.now().toString(), texto: novaTarefa.texto, hora: novaTarefa.hora, prioridade: novaTarefa.prioridade, feito: false, criadoEm: new Date().toISOString() };
    const nova = [...tarefas, t];
    setTarefas(nova);
    setNovaTarefa({ texto: "", hora: "", prioridade: "media" });
    await salvarAgenda(nova, undefined);
    registrarLog("AGENDA", `Adicionou tarefa: ${t.texto}`);
  };

  const toggleTarefa = async (id) => {
    const nova = tarefas.map(t => t.id === id ? { ...t, feito: !t.feito, concluidoEm: !t.feito ? new Date().toISOString() : null } : t);
    setTarefas(nova);
    await salvarAgenda(nova, undefined);
  };

  const excluirTarefa = async (id) => {
    const nova = tarefas.filter(t => t.id !== id);
    setTarefas(nova);
    await salvarAgenda(nova, undefined);
  };

  const transferirAmanha = async () => {
    const pendentes = tarefas.filter(t => !t.feito);
    if (pendentes.length === 0) { alert("Nenhuma tarefa pendente para transferir."); return; }
    const amanha = new Date(dataSel);
    amanha.setDate(amanha.getDate() + 1);
    const amanhaStr = amanha.toISOString().split('T')[0];
    const docAmanha = `agenda_${amanhaStr.replace(/-/g, '')}`;
    try {
      const docExistente = await db.collection('agenda_advocacia').doc(docAmanha).get();
      const tarefasExistentes = docExistente.exists ? (docExistente.data().tarefas || []) : [];
      const tarefasTransferidas = pendentes.map(t => ({ ...t, id: Date.now().toString() + Math.random(), transferidaDe: dataSel, feito: false }));
      await db.collection('agenda_advocacia').doc(docAmanha).set({
        data: amanhaStr,
        tarefas: [...tarefasExistentes, ...tarefasTransferidas],
        notas: docExistente.exists ? (docExistente.data().notas || "") : "",
        atualizadoEm: new Date().toISOString(),
        usuario: socio,
      });
      registrarLog("AGENDA", `Transferiu ${pendentes.length} tarefa(s) para ${amanhaStr}`);
      alert(`‚úÖ ${pendentes.length} tarefa(s) transferida(s) para amanh√£!`);
    } catch (e) { alert("Erro ao transferir tarefas."); }
  };

  const onNotasChange = (val) => {
    setNotas(val);
    clearTimeout(notasTimeout.current);
    notasTimeout.current = setTimeout(() => salvarAgenda(undefined, val), 1200);
  };

  const navegarDia = (delta) => {
    const d = new Date(dataSel);
    d.setDate(d.getDate() + delta);
    setDataSel(d.toISOString().split('T')[0]);
  };

  const feitas = tarefas.filter(t => t.feito).length;
  const total = tarefas.length;
  const progresso = total > 0 ? (feitas / total) * 100 : 0;

  const formatarData = (d) => {
    const dias = ['Domingo','Segunda-feira','Ter√ßa-feira','Quarta-feira','Quinta-feira','Sexta-feira','S√°bado'];
    const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const dt = new Date(d + 'T12:00:00');
    return `${dias[dt.getDay()]}, ${dt.getDate()} de ${meses[dt.getMonth()]} de ${dt.getFullYear()}`;
  };

  const isHoje = dataSel === hoje;

  const prioridadeCfg = { alta: { cls: 'priority-alta', cor: 'text-red-600', bg: 'bg-red-50', label: 'üî¥ Alta' }, media: { cls: 'priority-media', cor: 'text-amber-600', bg: 'bg-amber-50', label: 'üü° M√©dia' }, baixa: { cls: 'priority-baixa', cor: 'text-emerald-600', bg: 'bg-emerald-50', label: 'üü¢ Baixa' } };

  return (
    <div className="space-y-6 fade-in">
      {/* Header da Agenda */}
      <div className="bg-white rounded-xl shadow-sm p-6">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h2 className="text-xl font-bold text-slate-800" style={{fontFamily:'Playfair Display, serif'}}>
              <span className="text-gold mr-2">üìì</span>Agenda Di√°ria
            </h2>
            <p className="text-sm text-slate-500 mt-1">Seu di√°rio de metas e tarefas</p>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={() => navegarDia(-1)} className="p-2 rounded-lg border hover:bg-slate-50 text-slate-500 transition"><Icons.ChevLeft /></button>
            <div className="text-center">
              <input type="date" value={dataSel} onChange={e => setDataSel(e.target.value)} className="border rounded-lg px-3 py-2 text-sm font-medium text-slate-700" />
              {!isHoje && <button onClick={() => setDataSel(hoje)} className="block text-xs text-gold underline mx-auto mt-1">Ir para hoje</button>}
            </div>
            <button onClick={() => navegarDia(1)} className="p-2 rounded-lg border hover:bg-slate-50 text-slate-500 transition"><Icons.ChevRight /></button>
          </div>
        </div>

        <div className="mt-4 p-3 rounded-lg" style={{background:'#faf8f4', border:'1px solid #e8e0d0'}}>
          <p className="text-sm font-semibold text-slate-600">{formatarData(dataSel)}</p>
          {isHoje && <span className="text-xs font-bold text-gold uppercase tracking-wide">‚Ä¢ Hoje</span>}
        </div>

        {/* Barra de progresso */}
        {total > 0 && (
          <div className="mt-4">
            <div className="flex justify-between text-xs text-slate-500 mb-1">
              <span>{feitas} de {total} tarefas conclu√≠das</span>
              <span className="font-bold text-gold">{progresso.toFixed(0)}%</span>
            </div>
            <div className="w-full bg-slate-100 rounded-full h-2">
              <div className="h-2 rounded-full progress-bar" style={{width:`${progresso}%`, background: progresso === 100 ? '#10b981' : '#b49b67'}}/>
            </div>
          </div>
        )}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
        {/* COLUNA TAREFAS */}
        <div className="lg:col-span-3 space-y-4">
          <div className="bg-white rounded-xl shadow-sm p-5">
            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
              ‚úÖ Tarefas do Dia
              <span className="text-xs font-normal text-slate-400 ml-auto">{salvando ? 'üíæ Salvando...' : '‚úì Salvo'}</span>
            </h3>

            {/* Adicionar tarefa */}
            <div className="bg-slate-50 rounded-lg p-3 mb-4 border border-slate-100">
              <div className="flex gap-2 mb-2">
                <input
                  className="flex-1 p-2 border border-slate-200 rounded text-sm bg-white"
                  placeholder="Nova tarefa... (ex: Protocolar peti√ß√£o no PJE)"
                  value={novaTarefa.texto}
                  onChange={e => setNovaTarefa({...novaTarefa, texto: e.target.value})}
                  onKeyDown={e => e.key === 'Enter' && adicionarTarefa()}
                />
                <input
                  type="time"
                  className="p-2 border border-slate-200 rounded text-sm bg-white w-24"
                  value={novaTarefa.hora}
                  onChange={e => setNovaTarefa({...novaTarefa, hora: e.target.value})}
                />
              </div>
              <div className="flex gap-2 items-center">
                <select className="p-2 border border-slate-200 rounded text-xs bg-white flex-1" value={novaTarefa.prioridade} onChange={e => setNovaTarefa({...novaTarefa, prioridade: e.target.value})}>
                  <option value="alta">üî¥ Prioridade Alta</option>
                  <option value="media">üü° Prioridade M√©dia</option>
                  <option value="baixa">üü¢ Prioridade Baixa</option>
                </select>
                <button onClick={adicionarTarefa} className="px-4 py-2 rounded text-white text-sm font-bold flex items-center gap-1 transition hover:opacity-90" style={{background:'#1e293b'}}>
                  <Icons.Plus /> Adicionar
                </button>
              </div>
            </div>

            {/* Lista de tarefas */}
            {loading ? (
              <div className="text-center py-8 text-slate-400 text-sm">Carregando...</div>
            ) : tarefas.length === 0 ? (
              <div className="text-center py-10 text-slate-300">
                <div className="text-4xl mb-2">üìã</div>
                <p className="text-sm">Nenhuma tarefa para este dia.</p>
                <p className="text-xs mt-1">Adicione sua primeira tarefa acima!</p>
              </div>
            ) : (
              <div className="space-y-2">
                {/* Ordenar: pendentes primeiro, depois por prioridade */}
                {[...tarefas].sort((a,b) => {
                  if (a.feito !== b.feito) return a.feito ? 1 : -1;
                  const ordem = {alta:0, media:1, baixa:2};
                  return (ordem[a.prioridade]||1) - (ordem[b.prioridade]||1);
                }).map(t => (
                  <div key={t.id} className={`task-item flex items-start gap-3 p-3 rounded-lg border ${prioridadeCfg[t.prioridade]?.cls || 'priority-media'} ${t.feito ? 'task-done opacity-60 bg-slate-50' : 'bg-white'}`}>
                    <button onClick={() => toggleTarefa(t.id)} className={`mt-0.5 w-5 h-5 rounded flex-shrink-0 border-2 flex items-center justify-center transition ${t.feito ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300 hover:border-gold'}`}>
                      {t.feito && <Icons.Check />}
                    </button>
                    <div className="flex-1 min-w-0">
                      <p className={`text-sm font-medium task-text ${t.feito ? 'text-slate-400' : 'text-slate-700'}`}>{t.texto}</p>
                      <div className="flex items-center gap-3 mt-1">
                        {t.hora && <span className="text-xs text-slate-400 flex items-center gap-1"><Icons.Clock /> {t.hora}</span>}
                        {t.transferidaDe && <span className="text-xs text-amber-500">‚Ü© Transferida de {t.transferidaDe}</span>}
                        {t.feito && t.concluidoEm && <span className="text-xs text-emerald-500">‚úì Conclu√≠da</span>}
                        <span className={`text-xs font-medium px-1.5 py-0.5 rounded ${prioridadeCfg[t.prioridade]?.bg || ''} ${prioridadeCfg[t.prioridade]?.cor || ''}`}>
                          {t.prioridade === 'alta' ? 'Alta' : t.prioridade === 'media' ? 'M√©dia' : 'Baixa'}
                        </span>
                      </div>
                    </div>
                    <button onClick={() => excluirTarefa(t.id)} className="text-slate-200 hover:text-red-500 transition flex-shrink-0"><Icons.Trash /></button>
                  </div>
                ))}
              </div>
            )}

            {tarefas.filter(t => !t.feito).length > 0 && (
              <button onClick={transferirAmanha} className="mt-4 w-full py-2 border border-dashed border-amber-300 text-amber-600 rounded-lg text-sm font-medium hover:bg-amber-50 transition flex items-center justify-center gap-2">
                <Icons.Move /> Transferir pendentes para amanh√£
              </button>
            )}
          </div>
        </div>

        {/* COLUNA NOTAS */}
        <div className="lg:col-span-2 space-y-4">
          <div className="bg-white rounded-xl shadow-sm p-5">
            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
              üìù Notas do Dia
            </h3>
            <textarea
              className="w-full border border-slate-200 rounded-lg p-3 text-sm resize-none text-slate-700 leading-relaxed"
              rows={12}
              placeholder={"Suas anota√ß√µes do dia...\n\n‚Ä¢ Pontos importantes\n‚Ä¢ Observa√ß√µes de clientes\n‚Ä¢ Lembretes\n‚Ä¢ Ideias"}
              value={notas}
              onChange={e => onNotasChange(e.target.value)}
            />
            <p className="text-xs text-slate-300 mt-2 text-right">Salvo automaticamente</p>
          </div>

          {/* Resumo do dia */}
          <div className="bg-white rounded-xl shadow-sm p-5">
            <h3 className="font-bold text-slate-700 mb-3">üìä Resumo</h3>
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-slate-500">Total de tarefas</span>
                <span className="font-bold text-slate-700">{total}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-slate-500">‚úÖ Conclu√≠das</span>
                <span className="font-bold text-emerald-600">{feitas}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-slate-500">‚è≥ Pendentes</span>
                <span className="font-bold text-amber-600">{total - feitas}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-slate-500">üî¥ Alta prioridade</span>
                <span className="font-bold text-red-600">{tarefas.filter(t => t.prioridade === 'alta' && !t.feito).length}</span>
              </div>
              {progresso === 100 && total > 0 && (
                <div className="mt-3 p-3 bg-emerald-50 rounded-lg text-center">
                  <p className="text-emerald-700 font-bold text-sm">üèÜ Meta do dia atingida!</p>
                  <p className="text-emerald-600 text-xs mt-1">Excelente produtividade!</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// ============================================================
// COMPONENTE: PROCESSOS JUR√çDICOS
// ============================================================
const ProcessosJuridicos = ({ socio, userRole, db, registrarLog, privacidade }) => {
  const processoVazio = {
    numero: "", cliente: "", parteContraria: "", materia: "C√≠vel", status: "Em andamento",
    estado: "PE ‚Äì Pernambuco", cidade: "Recife", tribunal: "PJE-PE (TJ-PE)",
    vara: "", responsavel: "Escrit√≥rio",
    tipoPagamento: "fixo", valorContrato: "", percentualContrato: "", valorEntrada: "",
    observacoes: "", criadoEm: ""
  };

  const [processos, setProcessos] = useState([]);
  const [modal, setModal] = useState(false);
  const [editando, setEditando] = useState(null);
  const [form, setForm] = useState(processoVazio);
  const [busca, setBusca] = useState("");
  const [filtroMateria, setFiltroMateria] = useState("");
  const [filtroStatus, setFiltroStatus] = useState("");
  const [loading, setLoading] = useState(false);
  const [cidadesDaUF, setCidadesDaUF] = useState(ESTADOS_CIDADES["PE ‚Äì Pernambuco"] || []);

  useEffect(() => {
    if (!db) return;
    setLoading(true);
    const unsub = db.collection('processos_advocacia').orderBy('criadoEm', 'desc').onSnapshot(snap => {
      setProcessos(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      setLoading(false);
    }, () => setLoading(false));
    return () => unsub();
  }, []);

  // Atualizar cidades quando muda estado
  useEffect(() => {
    const cidades = ESTADOS_CIDADES[form.estado] || [];
    setCidadesDaUF(cidades);
    if (cidades.length > 0) setForm(f => ({ ...f, cidade: cidades[0] }));
  }, [form.estado]);

  const abrirModal = (processo = null) => {
    if (processo) {
      setEditando(processo.id);
      setForm({ ...processoVazio, ...processo });
      setCidadesDaUF(ESTADOS_CIDADES[processo.estado] || []);
    } else {
      setEditando(null);
      setForm({ ...processoVazio, responsavel: socio !== 'NB' ? socio : 'Escrit√≥rio', criadoEm: new Date().toISOString() });
    }
    setModal(true);
  };

  const salvar = async () => {
    if (!form.cliente.trim()) { alert("Informe o nome do cliente."); return; }
    if (userRole === 'viewer') { alert("Sem permiss√£o para esta a√ß√£o."); return; }
    try {
      const dados = { ...form, atualizadoEm: new Date().toISOString() };
      if (editando) {
        await db.collection('processos_advocacia').doc(editando).update(dados);
        registrarLog("PROCESSO EDITADO", `${form.cliente} ‚Äì ${form.numero}`);
      } else {
        dados.criadoEm = new Date().toISOString();
        await db.collection('processos_advocacia').add(dados);
        registrarLog("PROCESSO CADASTRADO", `${form.cliente} ‚Äì ${form.materia}`);
      }
      setModal(false);
      setForm(processoVazio);
      setEditando(null);
    } catch (e) { alert("Erro ao salvar processo: " + e.message); }
  };

  const excluir = async (p) => {
    if (userRole === 'viewer') { alert("Sem permiss√£o."); return; }
    if (!confirm(`Remover processo de ${p.cliente}?`)) return;
    await db.collection('processos_advocacia').doc(p.id).delete();
    registrarLog("PROCESSO EXCLU√çDO", `${p.cliente} ‚Äì ${p.numero}`);
  };

  const processosFiltrados = useMemo(() => {
    return processos.filter(p => {
      const lb = busca.toLowerCase();
      const matchBusca = !busca || p.cliente?.toLowerCase().includes(lb) || p.numero?.toLowerCase().includes(lb) || p.parteContraria?.toLowerCase().includes(lb);
      const matchMateria = !filtroMateria || p.materia === filtroMateria;
      const matchStatus = !filtroStatus || p.status === filtroStatus;
      return matchBusca && matchMateria && matchStatus;
    });
  }, [processos, busca, filtroMateria, filtroStatus]);

  const renderPagamento = (p) => {
    if (privacidade) return "‚Ä¢‚Ä¢‚Ä¢";
    if (p.tipoPagamento === 'percentual') return `${p.percentualContrato || 0}% s/ ganhos`;
    if (p.tipoPagamento === 'exito') return `√äxito: ${p.percentualContrato || 0}%`;
    if (p.tipoPagamento === 'misto') return `R$ ${Number(p.valorEntrada||0).toLocaleString('pt-BR')} + ${p.percentualContrato||0}%`;
    return `R$ ${Number(p.valorContrato||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
  };

  const estatisticas = useMemo(() => {
    const total = processos.length;
    const porMateria = {};
    processos.forEach(p => { porMateria[p.materia] = (porMateria[p.materia] || 0) + 1; });
    const ativos = processos.filter(p => !['Arquivado','Extinto com resolu√ß√£o do m√©rito','Extinto sem resolu√ß√£o do m√©rito','Transitado em julgado','Cancelado'].includes(p.status)).length;
    return { total, porMateria, ativos };
  }, [processos]);

  return (
    <div className="space-y-6 fade-in">
      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-white p-4 rounded-xl shadow-sm card-hover">
          <p className="text-xs font-bold text-slate-400 uppercase">Total</p>
          <p className="text-3xl font-bold text-slate-800">{estatisticas.total}</p>
          <p className="text-xs text-slate-400">processos cadastrados</p>
        </div>
        <div className="bg-white p-4 rounded-xl shadow-sm card-hover">
          <p className="text-xs font-bold text-slate-400 uppercase">Ativos</p>
          <p className="text-3xl font-bold text-emerald-600">{estatisticas.ativos}</p>
          <p className="text-xs text-slate-400">em andamento</p>
        </div>
        {Object.entries(estatisticas.porMateria).slice(0,2).map(([mat, qty]) => {
          const info = getMateriaInfo(mat);
          return (
            <div key={mat} className="bg-white p-4 rounded-xl shadow-sm card-hover">
              <p className="text-xs font-bold text-slate-400 uppercase">{mat}</p>
              <p className="text-3xl font-bold text-slate-800">{qty}</p>
              <span className={`text-xs font-bold px-2 py-0.5 rounded ${info.chip}`}>{mat}</span>
            </div>
          );
        })}
      </div>

      {/* Tabela */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        {/* Barra de controles */}
        <div className="p-4 border-b bg-slate-50 flex flex-col md:flex-row gap-3 items-center no-print">
          <div className="relative flex-1 min-w-0">
            <span className="absolute left-3 top-2.5 text-slate-400"><Icons.Search /></span>
            <input type="text" placeholder="Buscar por cliente, n√∫mero, parte contr√°ria..." className="w-full pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm" value={busca} onChange={e => setBusca(e.target.value)} />
          </div>
          <select className="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white" value={filtroMateria} onChange={e => setFiltroMateria(e.target.value)}>
            <option value="">Todas as mat√©rias</option>
            {MATERIAS.map(m => <option key={m.valor} value={m.valor}>{m.label}</option>)}
          </select>
          <select className="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white" value={filtroStatus} onChange={e => setFiltroStatus(e.target.value)}>
            <option value="">Todos os status</option>
            {STATUS_FLAT.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
          {(userRole === 'admin' || userRole === 'master') && (
            <button onClick={() => abrirModal()} className="flex items-center gap-1 px-4 py-2 rounded-lg text-white text-sm font-bold hover:opacity-90 transition flex-shrink-0" style={{background:'#1e293b'}}>
              <Icons.Plus /> Novo Processo
            </button>
          )}
        </div>

        {loading ? (
          <div className="text-center py-16 text-slate-400">Carregando processos...</div>
        ) : processosFiltrados.length === 0 ? (
          <div className="text-center py-16 text-slate-300">
            <div className="text-5xl mb-3">‚öñÔ∏è</div>
            <p className="text-slate-400 font-medium">Nenhum processo encontrado</p>
            <p className="text-slate-300 text-sm mt-1">Cadastre o primeiro processo clicando em "Novo Processo"</p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="bg-slate-100 text-slate-500 text-xs font-bold uppercase tracking-wide border-b">
                <tr>
                  <th className="px-4 py-3">Mat√©ria</th>
                  <th className="px-4 py-3">Cliente</th>
                  <th className="px-4 py-3">N¬∫ Processo</th>
                  <th className="px-4 py-3">Status</th>
                  <th className="px-4 py-3">Tribunal</th>
                  <th className="px-4 py-3">Pagamento</th>
                  <th className="px-4 py-3">Resp.</th>
                  <th className="px-4 py-3 no-print">A√ß√µes</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {processosFiltrados.map(p => {
                  const info = getMateriaInfo(p.materia);
                  return (
                    <tr key={p.id} className={`hover:bg-slate-50 transition ${info.row}`}>
                      <td className="px-4 py-3">
                        <span className={`text-xs font-bold px-2 py-1 rounded ${info.chip}`}>{p.materia}</span>
                      </td>
                      <td className="px-4 py-3">
                        <div className="font-semibold text-slate-800">{p.cliente}</div>
                        {p.parteContraria && <div className="text-xs text-slate-400">vs. {p.parteContraria}</div>}
                      </td>
                      <td className="px-4 py-3 font-mono text-xs text-slate-600">{p.numero || <span className="text-slate-300">‚Äî</span>}</td>
                      <td className="px-4 py-3">
                        <span className="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded">{p.status}</span>
                      </td>
                      <td className="px-4 py-3">
                        <div className="text-xs text-slate-600 font-medium">{p.tribunal}</div>
                        <div className="text-xs text-slate-400">{p.cidade}</div>
                      </td>
                      <td className="px-4 py-3 text-xs font-medium text-slate-700">{renderPagamento(p)}</td>
                      <td className="px-4 py-3 text-xs text-slate-500">{p.responsavel}</td>
                      <td className="px-4 py-3 no-print">
                        <div className="flex gap-2">
                          {(userRole === 'admin' || userRole === 'master') && (
                            <>
                              <button onClick={() => abrirModal(p)} className="text-slate-400 hover:text-gold transition"><Icons.Edit /></button>
                              <button onClick={() => excluir(p)} className="text-slate-400 hover:text-red-500 transition"><Icons.Trash /></button>
                            </>
                          )}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
        <div className="px-4 py-3 border-t text-xs text-slate-400 bg-slate-50">
          {processosFiltrados.length} processo(s) exibido(s) ¬∑ {processos.length} total
        </div>
      </div>

      {/* MODAL CADASTRO/EDI√á√ÉO */}
      {modal && (
        <div className="fixed inset-0 modal-backdrop bg-slate-900/60 flex items-center justify-center z-50 p-4 fade-in no-print">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 space-y-5 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center">
              <h3 className="font-bold text-xl text-slate-800" style={{fontFamily:'Playfair Display, serif'}}>
                {editando ? "‚úèÔ∏è Editar Processo" : "‚öñÔ∏è Novo Processo"}
              </h3>
              <button onClick={() => setModal(false)} className="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>

            {/* Identifica√ß√£o */}
            <div className="bg-slate-50 rounded-xl p-4 space-y-3">
              <p className="text-xs font-bold text-slate-500 uppercase tracking-wide">Identifica√ß√£o do Processo</p>
              <div className="grid grid-cols-2 gap-3">
                <div className="col-span-2">
                  <label className="text-xs font-bold text-slate-500 block mb-1">CLIENTE *</label>
                  <input className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="Nome completo do cliente" value={form.cliente} onChange={e => setForm({...form, cliente: e.target.value})} />
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1">PARTE CONTR√ÅRIA</label>
                  <input className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="R√©u / Autor / MP..." value={form.parteContraria} onChange={e => setForm({...form, parteContraria: e.target.value})} />
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1">N¬∫ DO PROCESSO</label>
                  <input className="w-full p-2.5 border border-slate-200 rounded-lg text-sm font-mono" placeholder="0000000-00.0000.0.00.0000" value={form.numero} onChange={e => setForm({...form, numero: e.target.value})} />
                </div>
              </div>
            </div>

            {/* Mat√©ria e Status */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-xs font-bold text-slate-500 block mb-1">MAT√âRIA DO DIREITO *</label>
                <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={form.materia} onChange={e => setForm({...form, materia: e.target.value})}>
                  {MATERIAS.map(m => <option key={m.valor} value={m.valor}>{m.label}</option>)}
                </select>
                {form.materia && <span className={`inline-block mt-1 text-xs font-bold px-2 py-0.5 rounded ${getMateriaInfo(form.materia).chip}`}>{form.materia}</span>}
              </div>
              <div>
                <label className="text-xs font-bold text-slate-500 block mb-1">STATUS DO PROCESSO</label>
                <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={form.status} onChange={e => setForm({...form, status: e.target.value})}>
                  {STATUS_PROCESSO.map(grupo => (
                    <optgroup key={grupo.grupo} label={grupo.grupo}>
                      {grupo.itens.map(s => <option key={s} value={s}>{s}</option>)}
                    </optgroup>
                  ))}
                </select>
              </div>
            </div>

            {/* Localiza√ß√£o e Tribunal */}
            <div className="bg-slate-50 rounded-xl p-4 space-y-3">
              <p className="text-xs font-bold text-slate-500 uppercase tracking-wide">Localiza√ß√£o & Tribunal</p>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1">ESTADO</label>
                  <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={form.estado} onChange={e => setForm({...form, estado: e.target.value})}>
                    {Object.keys(ESTADOS_CIDADES).map(uf => <option key={uf} value={uf}>{uf}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1">CIDADE</label>
                  <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={form.cidade} onChange={e => setForm({...form, cidade: e.target.value})}>
                    {cidadesDaUF.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1">SISTEMA / TRIBUNAL</label>
                  <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={form.tribunal} onChange={e => setForm({...form, tribunal: e.target.value})}>
                    {TRIBUNAIS_SISTEMAS.map(grupo => (
                      <optgroup key={grupo.grupo} label={grupo.grupo}>
                        {grupo.itens.map(t => <option key={t} value={t}>{t}</option>)}
                      </optgroup>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1">VARA / JU√çZO</label>
                  <input className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="Ex: 1¬™ Vara Criminal" value={form.vara} onChange={e => setForm({...form, vara: e.target.value})} />
                </div>
              </div>
            </div>

            {/* Pagamento */}
            <div className="bg-slate-50 rounded-xl p-4 space-y-3">
              <p className="text-xs font-bold text-slate-500 uppercase tracking-wide">üí∞ Contrato & Pagamento</p>
              <div>
                <label className="text-xs font-bold text-slate-500 block mb-2">TIPO DE CONTRATO</label>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {v:'fixo', label:'üíµ Valor Fixo', desc:'Honor√°rios em R$'},
                    {v:'percentual', label:'üìä Percentual', desc:'% sobre os ganhos'},
                    {v:'exito', label:'üèÜ √äxito', desc:'S√≥ cobra se ganhar'},
                    {v:'misto', label:'üîÄ Misto', desc:'Entrada + percentual'},
                  ].map(opt => (
                    <button key={opt.v} type="button" onClick={() => setForm({...form, tipoPagamento: opt.v})}
                      className={`p-2.5 rounded-lg border text-left transition ${form.tipoPagamento === opt.v ? 'border-amber-400 bg-amber-50' : 'border-slate-200 bg-white hover:bg-slate-50'}`}>
                      <div className="text-xs font-bold text-slate-700">{opt.label}</div>
                      <div className="text-xs text-slate-400">{opt.desc}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Campos din√¢micos por tipo */}
              {form.tipoPagamento === 'fixo' && (
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1">VALOR DO CONTRATO (R$)</label>
                  <input type="number" className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="Ex: 5000,00" value={form.valorContrato} onChange={e => setForm({...form, valorContrato: e.target.value})} />
                </div>
              )}
              {(form.tipoPagamento === 'percentual' || form.tipoPagamento === 'exito') && (
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1">PERCENTUAL SOBRE OS GANHOS (%)</label>
                  <div className="relative">
                    <input type="number" min="0" max="100" step="0.5" className="w-full p-2.5 border border-slate-200 rounded-lg text-sm pr-10" placeholder="Ex: 20" value={form.percentualContrato} onChange={e => setForm({...form, percentualContrato: e.target.value})} />
                    <span className="absolute right-3 top-2.5 text-slate-400 font-bold text-sm">%</span>
                  </div>
                  {form.percentualContrato && <p className="text-xs text-slate-400 mt-1">O escrit√≥rio receber√° {form.percentualContrato}% do valor obtido na causa.</p>}
                </div>
              )}
              {form.tipoPagamento === 'misto' && (
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-xs font-bold text-slate-500 block mb-1">ENTRADA (R$)</label>
                    <input type="number" className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="Ex: 2000,00" value={form.valorEntrada} onChange={e => setForm({...form, valorEntrada: e.target.value})} />
                  </div>
                  <div>
                    <label className="text-xs font-bold text-slate-500 block mb-1">PERCENTUAL (%)</label>
                    <div className="relative">
                      <input type="number" min="0" max="100" step="0.5" className="w-full p-2.5 border border-slate-200 rounded-lg text-sm pr-8" placeholder="Ex: 15" value={form.percentualContrato} onChange={e => setForm({...form, percentualContrato: e.target.value})} />
                      <span className="absolute right-3 top-2.5 text-slate-400 font-bold text-sm">%</span>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Respons√°vel e Observa√ß√µes */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-xs font-bold text-slate-500 block mb-1">RESPONS√ÅVEL</label>
                <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={form.responsavel} onChange={e => setForm({...form, responsavel: e.target.value})}>
                  <option>Escrit√≥rio</option><option>Evison</option><option>Adiellyson</option>
                </select>
              </div>
              <div>
                <label className="text-xs font-bold text-slate-500 block mb-1">OBSERVA√á√ïES</label>
                <textarea className="w-full p-2.5 border border-slate-200 rounded-lg text-sm resize-none" rows={2} placeholder="Notas sobre o caso..." value={form.observacoes} onChange={e => setForm({...form, observacoes: e.target.value})} />
              </div>
            </div>

            <div className="flex gap-3 pt-2">
              <button onClick={() => { setModal(false); setEditando(null); }} className="flex-1 py-2.5 border border-slate-200 rounded-lg text-slate-500 hover:bg-slate-50 font-medium text-sm">Cancelar</button>
              <button onClick={salvar} className="flex-1 py-2.5 rounded-lg text-white font-bold text-sm hover:opacity-90 transition" style={{background:'#1e293b'}}>
                {editando ? "Salvar Altera√ß√µes" : "Cadastrar Processo"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================
// APP PRINCIPAL
// ============================================================
const AppContent = () => {
  const [authOk, setAuthOk] = useState(false);
  const [socio, setSocio] = useState("");
  const [nomeCompleto, setNomeCompleto] = useState("");
  const [userRole, setUserRole] = useState("viewer");
  const [transacoes, setTransacoes] = useState([]);
  const [logs, setLogs] = useState([]);
  const [modal, setModal] = useState(false);
  const [modalSenha, setModalSenha] = useState(false);
  const [novaSenha, setNovaSenha] = useState("");
  const [aba, setAba] = useState('dash');
  const [novo, setNovo] = useState({ data: new Date().toISOString().split('T')[0], tipo: 'entrada', valor: '', descricao: '', categoria: 'Honor√°rios Contratuais', responsavel: 'Escrit√≥rio', status: 'pago' });
  const [privacidade, setPrivacidade] = useState(false);
  const [metaMensal, setMetaMensal] = useState(50000);
  const [busca, setBusca] = useState("");
  const [listaUsuarios, setListaUsuarios] = useState([]);
  const [novoUsuario, setNovoUsuario] = useState({ nome: "", senha: "", role: "viewer" });

  const registrarLog = useCallback(async (acao, detalhe) => {
    if (!db) return;
    try {
      await db.collection('auditoria_advocacia').add({ data: new Date().toISOString(), usuario: nomeCompleto || socio, acao, detalhe });
    } catch (e) { console.error("Erro log:", e); }
  }, [nomeCompleto, socio]);

  const handleLogin = (nomeFull, role) => {
    const primeiroNome = nomeFull.split(' ')[0];
    setSocio(primeiroNome);
    setNomeCompleto(nomeFull);
    setUserRole(role);
    setNovo(p => ({ ...p, responsavel: primeiroNome !== 'NB' ? primeiroNome : 'Escrit√≥rio' }));
    setAuthOk(true);
    setTimeout(() => registrarLog("LOGIN", `Acesso como ${role.toUpperCase()}`), 1500);
  };

  const handleLogout = async () => {
    await registrarLog("LOGOUT", "Sa√≠da do sistema.");
    window.location.reload();
  };

  const carregarUsuarios = async () => {
    if (!db || userRole !== 'master') return;
    const snap = await db.collection('credenciais_advocacia').get();
    setListaUsuarios(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
  };

  const salvarUsuario = async () => {
    if (!db || userRole !== 'master') return;
    if (!novoUsuario.nome || !novoUsuario.senha) return alert("Preencha nome e senha.");
    try {
      await db.collection('credenciais_advocacia').doc(novoUsuario.nome).set({ senha: novoUsuario.senha, role: novoUsuario.role });
      alert("Usu√°rio salvo!");
      setNovoUsuario({ nome: "", senha: "", role: "viewer" });
      carregarUsuarios();
      registrarLog("GEST√ÉO USU√ÅRIO", `Criou/Editou: ${novoUsuario.nome} como ${novoUsuario.role}`);
    } catch (e) { alert("Erro ao salvar."); }
  };

  const excluirUsuario = async (id) => {
    if (!confirm("Remover este usu√°rio?")) return;
    await db.collection('credenciais_advocacia').doc(id).delete();
    carregarUsuarios();
    registrarLog("GEST√ÉO USU√ÅRIO", `Removeu: ${id}`);
  };

  useEffect(() => { if (aba === 'usuarios') carregarUsuarios(); }, [aba]);

  const alterarSenha = async () => {
    if (userRole === 'master') { alert("Senha mestre n√£o alter√°vel aqui."); return; }
    if (!novaSenha || novaSenha.length < 4) { alert("M√≠nimo 4 caracteres."); return; }
    try {
      await db.collection('credenciais_advocacia').doc(nomeCompleto).set({ senha: novaSenha }, { merge: true });
      await registrarLog("SEGURAN√áA", "Alterou a pr√≥pria senha.");
      alert("Senha alterada!");
      setModalSenha(false); setNovaSenha("");
    } catch (e) { alert("Erro: " + e.message); }
  };

  const exportarExcel = () => {
    try {
      if (!window.XLSX) { alert("Biblioteca n√£o carregada."); return; }
      const dadosFormatados = transacoes.map(t => ({
        "Data": new Date(t.data).toLocaleDateString('pt-BR'),
        "Tipo": t.tipo === 'entrada' ? 'Receita' : 'Despesa',
        "Status": t.status === 'pendente' ? 'PENDENTE' : 'PAGO',
        "Descri√ß√£o": t.descricao, "Categoria": t.categoria,
        "Valor (R$)": t.valor, "Respons√°vel": t.responsavel
      }));
      const ws = XLSX.utils.json_to_sheet(dadosFormatados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Fluxo");
      XLSX.writeFile(wb, `NB_Backup_${new Date().toISOString().split('T')[0]}.xlsx`);
      registrarLog("BACKUP", "Excel exportado.");
    } catch (e) { alert("Erro ao exportar."); }
  };

  useEffect(() => { if (authOk) auth.signInAnonymously().catch(console.error); }, [authOk]);

  useEffect(() => {
    if (!authOk) return;
    const unsub = db.collection('financeiro_advocacia').orderBy('criadoEm', 'desc').onSnapshot(snap => {
      const d = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      d.sort((a, b) => new Date(b.data) - new Date(a.data));
      setTransacoes(d);
    });
    return () => unsub();
  }, [authOk]);

  useEffect(() => {
    if (!authOk || aba !== 'auditoria') return;
    const unsub = db.collection('auditoria_advocacia').orderBy('data', 'desc').limit(50).onSnapshot(snap => {
      setLogs(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    return () => unsub();
  }, [authOk, aba]);

  const metricas = useMemo(() => {
    let rec = 0, desp = 0;
    let pSocio = { 'Evison': 0, 'Adiellyson': 0, 'Escrit√≥rio': 0 };
    let porCategoria = {};
    const mesAtualStr = new Date().toISOString().slice(0, 7);
    const transacoesMes = transacoes.filter(t => t.data.startsWith(mesAtualStr));
    transacoesMes.forEach(t => {
      const v = parseFloat(t.valor || 0);
      if (t.status === 'pendente' && t.categoria !== 'Repasse Cliente') return;
      const resp = t.responsavel || 'Escrit√≥rio';
      if (!porCategoria[t.categoria]) porCategoria[t.categoria] = { val: 0, tipo: t.tipo };
      porCategoria[t.categoria].val += v;
      if (t.tipo === 'entrada') {
        rec += v;
        if (pSocio[resp] !== undefined) pSocio[resp] += v; else pSocio['Escrit√≥rio'] += v;
      } else { desp += v; }
    });
    const ranking = Object.keys(porCategoria).map(k => ({ cat: k, ...porCategoria[k] })).sort((a, b) => b.val - a.val).slice(0, 5);
    const hoje = new Date();
    const diasNoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();
    const mediaDiaria = hoje.getDate() > 0 ? rec / hoje.getDate() : 0;
    const projecao = mediaDiaria * diasNoMes;
    const margem = rec > 0 ? ((rec - desp) / rec) * 100 : 0;
    let saude = { cor: "text-red-600", texto: "Cr√≠tico", bg: "bg-red-50" };
    if (margem > 30) saude = { cor: "text-emerald-600", texto: "Excelente", bg: "bg-emerald-50" };
    else if (margem > 10) saude = { cor: "text-amber-600", texto: "Aten√ß√£o", bg: "bg-amber-50" };
    return { rec, desp, liq: rec - desp, pSocio, projecao, saude, ranking };
  }, [transacoes]);

  const transacoesExibidas = useMemo(() => {
    if (!busca) return transacoes;
    const lb = busca.toLowerCase();
    return transacoes.filter(t => t.descricao?.toLowerCase().includes(lb) || t.categoria?.toLowerCase().includes(lb) || t.responsavel?.toLowerCase().includes(lb) || t.valor?.toString().includes(lb));
  }, [transacoes, busca]);

  const salvar = async () => {
    if (!novo.valor) return;
    if (userRole === 'viewer') return alert("Sem permiss√£o para lan√ßamentos.");
    try {
      await db.collection('financeiro_advocacia').add({ ...novo, valor: parseFloat(novo.valor), criadoEm: new Date().toISOString() });
      await registrarLog("LAN√áAMENTO", `${novo.tipo}: R$ ${novo.valor}`);
      setModal(false);
      setNovo({ ...novo, valor: '', descricao: '' });
    } catch (e) { alert("Erro: " + e.message); }
  };

  const apagar = async (t) => {
    if (userRole === 'viewer') return alert("Sem permiss√£o.");
    if (confirm("Apagar este lan√ßamento?")) {
      await db.collection('financeiro_advocacia').doc(t.id).delete();
      await registrarLog("EXCLUS√ÉO", `${t.descricao}: R$ ${t.valor}`);
    }
  };

  const limparAuditoria = async () => {
    if (userRole !== 'master') return alert("Apenas o Mestre pode limpar.");
    if (!confirm("Apagar todo o hist√≥rico de auditoria?")) return;
    const batch = db.batch();
    const snap = await db.collection('auditoria_advocacia').get();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    registrarLog("LIMPEZA", "Auditoria limpa pelo Mestre.");
  };

  const fmt = (v) => {
    if (privacidade) return "R$ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
  };
  const fmtData = (d) => new Date(d).toLocaleDateString('pt-BR');
  const fmtHora = (d) => new Date(d).toLocaleString('pt-BR');

  if (!authOk) return <LoginScreen onLogin={handleLogin} />;

  const ABAS = [
    { id: 'dash', label: 'Dashboard', icon: 'üìä' },
    { id: 'processos', label: 'Processos', icon: '‚öñÔ∏è' },
    { id: 'extrato', label: 'Extrato', icon: 'üí≥' },
    { id: 'agenda', label: 'Agenda', icon: 'üìì' },
    { id: 'auditoria', label: 'Auditoria', icon: 'üîç' },
    ...(userRole === 'master' ? [{ id: 'usuarios', label: 'Equipe', icon: 'üë•' }] : []),
  ];

  return (
    <div className="min-h-screen pb-20 fade-in" style={{background:'var(--cream)'}}>
      {/* HEADER */}
      <header className="bg-white border-b px-6 py-3 sticky top-0 z-30 shadow-sm" style={{borderBottomColor:'#f0ece4'}}>
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="text-gold"><Icons.Scale /></div>
            <div>
              <h1 className="text-lg font-bold text-slate-900 leading-none" style={{fontFamily:'Playfair Display, serif'}}>NASCIMENTO & BOMFIM</h1>
              <span className="text-xs text-slate-400 flex items-center gap-1.5">
                Ol√°, <strong className="text-slate-600">{socio}</strong>
                <span className={`px-1.5 py-0.5 rounded text-[10px] uppercase font-bold ${userRole==='master'?'tag-master':userRole==='admin'?'tag-admin':'tag-viewer'}`}>{userRole}</span>
              </span>
            </div>
          </div>

          <div className="flex items-center gap-1">
            <button onClick={() => setPrivacidade(!privacidade)} className="p-2 text-slate-400 hover:text-navy rounded-lg hover:bg-slate-50 transition" title="Ocultar Valores">
              {privacidade ? <Icons.EyeOff /> : <Icons.Eye />}
            </button>
            <div className="h-6 w-px bg-slate-200 mx-1" />
            {ABAS.map(a => (
              <button key={a.id} onClick={() => setAba(a.id)} className={`nav-pill px-3 py-1.5 text-xs font-bold transition flex items-center gap-1 ${aba===a.id?'active':' text-slate-500'}`}>
                <span>{a.icon}</span><span className="hidden md:inline">{a.label}</span>
              </button>
            ))}
            <div className="h-6 w-px bg-slate-200 mx-1" />
            {userRole !== 'master' && (
              <button onClick={() => setModalSenha(true)} className="p-2 text-slate-400 hover-gold rounded-lg hover:bg-slate-50 transition" title="Alterar Senha"><Icons.Key /></button>
            )}
            {(userRole === 'admin' || userRole === 'master') && aba === 'extrato' && (
              <button onClick={() => setModal(true)} className="px-3 py-1.5 rounded-lg text-white text-xs font-bold hover:opacity-90 flex items-center gap-1 transition" style={{background:'#b49b67'}}>
                <Icons.Plus /> Lan√ßamento
              </button>
            )}
            {(userRole === 'admin' || userRole === 'master') && aba === 'dash' && (
              <button onClick={() => setModal(true)} className="px-3 py-1.5 rounded-lg text-white text-xs font-bold hover:opacity-90 flex items-center gap-1 transition" style={{background:'#b49b67'}}>
                <Icons.Plus /> Novo
              </button>
            )}
            <button onClick={handleLogout} className="p-2 text-slate-400 hover:text-red-500 rounded-lg hover:bg-slate-50 transition" title="Sair"><Icons.LogOut /></button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-8 space-y-6">

        {/* ===== PROCESSOS ===== */}
        {aba === 'processos' && (
          <ProcessosJuridicos socio={socio} userRole={userRole} db={db} registrarLog={registrarLog} privacidade={privacidade} />
        )}

        {/* ===== AGENDA ===== */}
        {aba === 'agenda' && (
          <AgendaDiaria socio={socio} db={db} registrarLog={registrarLog} />
        )}

        {/* ===== GEST√ÉO USU√ÅRIOS ===== */}
        {aba === 'usuarios' && userRole === 'master' && (
          <div className="bg-white rounded-xl shadow-sm p-6 fade-in">
            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2 text-lg" style={{fontFamily:'Playfair Display, serif'}}><Icons.Users /> Gest√£o da Equipe</h3>
            <div className="bg-slate-50 p-4 rounded-xl mb-6 border border-slate-100">
              <h4 className="text-sm font-bold text-slate-600 mb-3">Adicionar / Editar Usu√°rio</h4>
              <div className="flex gap-3 items-end flex-wrap">
                <div className="flex-1 min-w-40">
                  <label className="text-xs text-slate-500 block mb-1">Nome</label>
                  <input className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="Nome do Usu√°rio" value={novoUsuario.nome} onChange={e => setNovoUsuario({ ...novoUsuario, nome: e.target.value })} />
                </div>
                <div className="flex-1 min-w-32">
                  <label className="text-xs text-slate-500 block mb-1">Senha</label>
                  <input type="text" className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" placeholder="Senha" value={novoUsuario.senha} onChange={e => setNovoUsuario({ ...novoUsuario, senha: e.target.value })} />
                </div>
                <div className="w-44">
                  <label className="text-xs text-slate-500 block mb-1">Permiss√£o</label>
                  <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={novoUsuario.role} onChange={e => setNovoUsuario({ ...novoUsuario, role: e.target.value })}>
                    <option value="viewer">Visualizador</option>
                    <option value="admin">Administrador</option>
                  </select>
                </div>
                <button onClick={salvarUsuario} className="px-5 py-2.5 rounded-lg text-white font-bold text-sm hover:opacity-90 transition" style={{background:'#1e293b'}}>Salvar</button>
              </div>
            </div>
            <table className="w-full text-sm">
              <thead className="bg-slate-100 text-slate-500 text-xs font-bold uppercase border-b">
                <tr><th className="px-4 py-3">Nome</th><th className="px-4 py-3">Senha</th><th className="px-4 py-3">Permiss√£o</th><th className="px-4 py-3">A√ß√£o</th></tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {listaUsuarios.map(u => (
                  <tr key={u.id} className="hover:bg-slate-50">
                    <td className="px-4 py-3 font-bold text-slate-700">{u.id}</td>
                    <td className="px-4 py-3 font-mono text-slate-500">{u.senha}</td>
                    <td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs font-bold ${u.role==='admin'?'tag-admin':u.role==='master'?'tag-master':'tag-viewer'}`}>{u.role}</span></td>
                    <td className="px-4 py-3"><button onClick={() => excluirUsuario(u.id)} className="text-red-500 hover:text-red-700 text-xs font-bold uppercase">Remover</button></td>
                  </tr>
                ))}
                {listaUsuarios.length === 0 && <tr><td colSpan="4" className="text-center py-8 text-slate-300">Nenhum usu√°rio cadastrado.</td></tr>}
              </tbody>
            </table>
          </div>
        )}

        {/* ===== DASHBOARD ===== */}
        {aba === 'dash' && (
          <div className="space-y-6 fade-in print-break">
            <div className="bg-white p-5 rounded-xl shadow-sm">
              <div className="flex justify-between items-end mb-2">
                <div>
                  <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-2"><Icons.Target /> Meta do M√™s</h3>
                  <p className="text-2xl font-bold text-slate-800 mt-1">{fmt(metricas.rec)} <span className="text-sm text-slate-300 font-normal">/ {fmt(metaMensal)}</span></p>
                </div>
                <span className="text-sm font-bold text-gold">{Math.min(100, (metricas.rec / metaMensal) * 100).toFixed(1)}%</span>
              </div>
              <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                <div className="bg-gold h-2.5 rounded-full progress-bar" style={{ width: `${Math.min(100, (metricas.rec / metaMensal) * 100)}%` }} />
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-emerald-500 card-hover">
                <p className="text-xs font-bold text-slate-400 uppercase">Faturamento (M√™s)</p>
                <h3 className="text-2xl font-bold text-slate-800 mt-1">{fmt(metricas.rec)}</h3>
              </div>
              <div className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-400 card-hover">
                <p className="text-xs font-bold text-slate-400 uppercase flex items-center gap-1"><Icons.TrendUp /> Proje√ß√£o</p>
                <h3 className="text-2xl font-bold text-blue-600 mt-1">{fmt(metricas.projecao)}</h3>
              </div>
              <div className={`p-5 rounded-xl shadow-sm border-l-4 card-hover ${metricas.saude.bg} border-l-emerald-400`}>
                <p className="text-xs font-bold text-slate-400 uppercase">Sa√∫de Financeira</p>
                <h3 className={`text-2xl font-bold mt-1 ${metricas.saude.cor}`}>{metricas.saude.texto}</h3>
              </div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm col-span-2 h-80">
                <h4 className="font-bold text-slate-700 mb-4">Fluxo de Caixa (M√™s Atual)</h4>
                <div className="h-64"><FinanceChart type="bar" data={{ receita: metricas.rec, despesa: metricas.desp, liquido: metricas.liq }} /></div>
              </div>
              <div className="bg-white p-6 rounded-xl shadow-sm h-80">
                <h4 className="font-bold text-slate-700 mb-4">Top Categorias</h4>
                <div className="space-y-3 overflow-y-auto h-64 pr-1">
                  {metricas.ranking.map((r, i) => (
                    <div key={i} className="flex justify-between items-center text-sm border-b border-slate-50 pb-2">
                      <span className="font-medium text-slate-600 truncate">{r.cat}</span>
                      <span className={`font-bold ml-2 flex-shrink-0 ${r.tipo==='entrada'?'text-emerald-600':'text-red-500'}`}>{fmt(r.val)}</span>
                    </div>
                  ))}
                  {metricas.ranking.length === 0 && <p className="text-slate-300 text-sm text-center pt-10">Sem dados este m√™s</p>}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ===== EXTRATO ===== */}
        {aba === 'extrato' && (
          <div className="bg-white rounded-xl shadow-sm overflow-hidden fade-in print-break">
            <div className="p-4 border-b flex flex-col md:flex-row justify-between items-center bg-slate-50 gap-3 no-print">
              <h3 className="font-bold text-slate-700">Hist√≥rico Completo</h3>
              <div className="flex gap-2 w-full md:w-auto items-center">
                <div className="relative flex-1">
                  <span className="absolute left-3 top-2.5 text-slate-400"><Icons.Search /></span>
                  <input type="text" placeholder="Buscar lan√ßamento..." className="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm w-full" value={busca} onChange={e => setBusca(e.target.value)} />
                </div>
                <button onClick={exportarExcel} className="text-xs flex items-center gap-1 bg-white border border-emerald-500 text-emerald-700 px-3 py-2 rounded-lg hover:bg-emerald-50 font-bold transition">
                  <Icons.Excel /> Excel
                </button>
              </div>
            </div>
            <table className="w-full text-sm text-left">
              <thead className="bg-slate-50 text-slate-400 text-xs font-bold uppercase border-b">
                <tr><th className="px-6 py-3">Data</th><th className="px-6 py-3">Descri√ß√£o</th><th className="px-6 py-3">Status</th><th className="px-6 py-3">Valor</th><th className="px-6 py-3 no-print">A√ß√£o</th></tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {transacoesExibidas.map(t => (
                  <tr key={t.id} className="hover:bg-slate-50 transition">
                    <td className="px-6 py-4 text-slate-400 text-xs">{fmtData(t.data)}</td>
                    <td className="px-6 py-4">
                      <div className="font-semibold text-slate-700">{t.descricao}</div>
                      <div className="text-xs text-slate-400">{t.responsavel} ¬∑ {t.categoria}</div>
                    </td>
                    <td className="px-6 py-4">
                      <span className={`px-2 py-1 rounded text-xs font-bold ${t.status==='pendente'?'bg-amber-50 text-amber-600':'bg-slate-100 text-slate-500'}`}>
                        {t.status === 'pendente' ? '‚è≥ Pendente' : '‚úì Pago'}
                      </span>
                    </td>
                    <td className={`px-6 py-4 font-bold ${t.tipo==='entrada'?'text-emerald-600':'text-red-500'}`}>{t.tipo==='saida'?'-':''}{fmt(t.valor)}</td>
                    <td className="px-6 py-4 no-print">
                      {(userRole === 'admin' || userRole === 'master') && (
                        <button onClick={() => apagar(t)} className="text-slate-200 hover:text-red-500 transition"><Icons.Trash /></button>
                      )}
                    </td>
                  </tr>
                ))}
                {transacoesExibidas.length === 0 && (
                  <tr><td colSpan="5" className="text-center py-12 text-slate-300">Nenhum lan√ßamento encontrado.</td></tr>
                )}
              </tbody>
            </table>
          </div>
        )}

        {/* ===== AUDITORIA ===== */}
        {aba === 'auditoria' && (
          <div className="bg-white rounded-xl shadow-sm overflow-hidden fade-in">
            <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
              <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icons.History /> Auditoria do Sistema</h3>
              {userRole === 'master' && (
                <button onClick={limparAuditoria} className="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded-lg font-bold hover:bg-red-200 transition">LIMPAR TUDO</button>
              )}
            </div>
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-400 text-xs font-bold uppercase border-b">
                <tr><th className="px-6 py-3">Data/Hora</th><th className="px-6 py-3">Usu√°rio</th><th className="px-6 py-3">A√ß√£o</th><th className="px-6 py-3">Detalhes</th></tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {logs.map(l => (
                  <tr key={l.id} className="hover:bg-slate-50">
                    <td className="px-6 py-3 text-slate-400 font-mono text-xs">{fmtHora(l.data)}</td>
                    <td className="px-6 py-3 font-bold text-slate-700">{l.usuario}</td>
                    <td className="px-6 py-3">
                      <span className={`px-2 py-1 rounded text-xs font-bold ${l.acao==='LOGIN'?'bg-blue-50 text-blue-600':l.acao==='EXCLUS√ÉO'||l.acao==='PROCESSO EXCLU√çDO'?'bg-red-50 text-red-600':l.acao==='PROCESSO CADASTRADO'?'bg-emerald-50 text-emerald-600':'bg-slate-100 text-slate-500'}`}>{l.acao}</span>
                    </td>
                    <td className="px-6 py-3 text-slate-600 text-xs">{l.detalhe}</td>
                  </tr>
                ))}
                {logs.length === 0 && <tr><td colSpan="4" className="text-center py-10 text-slate-300">Sem registros.</td></tr>}
              </tbody>
            </table>
          </div>
        )}
      </main>

      {/* MODAL LAN√áAMENTO FINANCEIRO */}
      {modal && (
        <div className="fixed inset-0 modal-backdrop bg-slate-900/60 flex items-center justify-center z-50 p-4 fade-in no-print">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 space-y-4">
            <h3 className="font-bold text-xl text-slate-800" style={{fontFamily:'Playfair Display, serif'}}>üí∞ Novo Lan√ßamento</h3>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Tipo</label>
                <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={novo.tipo} onChange={e => setNovo({ ...novo, tipo: e.target.value })}>
                  <option value="entrada">Entrada</option><option value="saida">Sa√≠da</option>
                </select>
              </div>
              <div>
                <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Data</label>
                <input type="date" className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" value={novo.data} onChange={e => setNovo({ ...novo, data: e.target.value })} />
              </div>
            </div>
            <div>
              <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Valor (R$)</label>
              <input type="number" placeholder="0,00" className="w-full p-2.5 border border-slate-200 rounded-lg text-lg font-bold" value={novo.valor} onChange={e => setNovo({ ...novo, valor: e.target.value })} />
            </div>
            <div>
              <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Descri√ß√£o</label>
              <input type="text" placeholder="Ex: Honor√°rios..." className="w-full p-2.5 border border-slate-200 rounded-lg text-sm" value={novo.descricao} onChange={e => setNovo({ ...novo, descricao: e.target.value })} />
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Status</label>
                <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white font-semibold" value={novo.status} onChange={e => setNovo({ ...novo, status: e.target.value })}>
                  <option value="pago">‚úì PAGO / REALIZADO</option>
                  <option value="pendente">‚è≥ PENDENTE / FUTURO</option>
                </select>
              </div>
              <div>
                <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Categoria</label>
                <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={novo.categoria} onChange={e => setNovo({ ...novo, categoria: e.target.value })}>
                  <option>Honor√°rios Contratuais</option><option>Sucumb√™ncia</option>
                  <option>Consultoria</option><option>Repasse Cliente</option>
                  <option>Repasse Parceiros</option><option>Estagi√°rio</option>
                  <option>Infraestrutura</option><option>Pessoal</option>
                  <option>Tecnologia</option><option>Marketing</option>
                  <option>Impostos</option><option>S√≥cios</option>
                </select>
              </div>
            </div>
            <div>
              <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Respons√°vel</label>
              <select className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white" value={novo.responsavel} onChange={e => setNovo({ ...novo, responsavel: e.target.value })}>
                <option>Escrit√≥rio</option><option>Evison</option><option>Adiellyson</option>
              </select>
            </div>
            <div className="flex gap-3 pt-1">
              <button onClick={() => setModal(false)} className="flex-1 py-2.5 border border-slate-200 rounded-lg text-slate-500 hover:bg-slate-50 font-medium text-sm">Cancelar</button>
              <button onClick={salvar} className="flex-1 py-2.5 rounded-lg text-white font-bold text-sm hover:opacity-90 transition" style={{background:'#1e293b'}}>Salvar</button>
            </div>
          </div>
        </div>
      )}

      {/* MODAL ALTERAR SENHA */}
      {modalSenha && (
        <div className="fixed inset-0 modal-backdrop bg-slate-900/60 flex items-center justify-center z-50 p-4 fade-in no-print">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 space-y-4">
            <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2" style={{fontFamily:'Playfair Display, serif'}}><Icons.Key /> Alterar Senha</h3>
            <p className="text-sm text-slate-500">Defina uma nova senha para seu acesso.</p>
            <div>
              <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Nova Senha</label>
              <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="w-full p-2.5 border border-slate-200 rounded-lg" value={novaSenha} onChange={e => setNovaSenha(e.target.value)} />
            </div>
            <div className="flex gap-3">
              <button onClick={() => { setModalSenha(false); setNovaSenha(""); }} className="flex-1 py-2.5 border border-slate-200 rounded-lg text-slate-500 hover:bg-slate-50 font-medium text-sm">Cancelar</button>
              <button onClick={alterarSenha} className="flex-1 py-2.5 rounded-lg text-white font-bold text-sm hover:opacity-90 transition" style={{background:'#1e293b'}}>Confirmar</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

class ErrorBoundary extends Component {
  constructor(props) { super(props); this.state = { hasError: false, error: null }; }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, info) { console.error("App Error:", error, info); }
  render() {
    if (this.state.hasError) return (
      <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
        <div className="bg-white rounded-xl p-8 shadow text-center max-w-md">
          <div className="text-4xl mb-4">‚ö†Ô∏è</div>
          <h2 className="font-bold text-slate-800 text-lg mb-2">Erro Inesperado</h2>
          <p className="text-slate-500 text-sm mb-4">Ocorreu um erro na aplica√ß√£o.</p>
          <button onClick={() => window.location.reload()} className="px-6 py-2 bg-slate-800 text-white rounded-lg font-medium">Recarregar</button>
        </div>
      </div>
    );
    return this.props.children;
  }
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ErrorBoundary><AppContent /></ErrorBoundary>);
</script>
</body>
</html>
